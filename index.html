<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Book</title>
<style>
  :root{
    --bg:#0b0b0b;
    --card:#1d1f23;
    --cardBorder:rgba(255,255,255,.08);
    --muted:rgba(255,255,255,.66);
    --ink:#fff;
    --accent:#1e8bff;
    --accentHover:#2a96ff;
    --line:rgba(255,255,255,.16);
    --lineActive:#1e8bff;
    --shadow:0 18px 48px rgba(0,0,0,.45);
    --radiusCard:26px;
    --t:.28s cubic-bezier(.2,.8,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,Inter,system-ui,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
    color-scheme:dark;
  }

  .page{width:clamp(320px,92vw,420px); margin:0 auto; padding:22px 16px 40px;}
  h1{font-size:48px; line-height:1; margin:6px 4px 18px; font-weight:800; letter-spacing:-.4px}

  .card{
    position:relative; background:var(--card); border:1px solid var(--cardBorder);
    border-radius:var(--radiusCard); box-shadow:var(--shadow); padding:22px 20px 24px;
  }

  .grid{display:grid; grid-template-columns:1fr; row-gap:20px}
  .label{font-size:16px; color:var(--muted); margin:0 0 8px;}
  .row{position:relative}
  .line-wrap{position:relative; padding:0 0 12px;}
  .line-wrap::after{content:""; position:absolute; left:0; right:0; bottom:0; height:2px; background:var(--line); border-radius:2px;}
  .input, .select select{width:100%; background:transparent; border:0; outline:0; color:var(--ink); font-size:21px; padding:6px 34px 6px 0; line-height:1.25;}
  .input::placeholder{color:rgba(255,255,255,.55)}
  .focusbar{position:absolute; left:0; right:0; bottom:-1px; height:2px; background:var(--lineActive); transform:scaleX(0); transform-origin:left; transition:transform var(--t)}
  .input:focus ~ .focusbar, .select select:focus ~ .focusbar{transform:scaleX(1)}
  input[type="date"]{-webkit-appearance:none; appearance:none}
  input[type="date"]::-webkit-calendar-picker-indicator{opacity:0}
  .select{position:relative}
  .icon{position:absolute; right:0; top:50%; transform:translateY(-50%); width:20px; height:20px}
  .icon svg{width:100%; height:100%; display:block}
  .icon svg *{stroke:var(--accent); fill:none; stroke-width:1.9; stroke-linecap:round; stroke-linejoin:round}

  .swap{
    position:absolute; left:50%; top:-18px; transform:translateX(-50%);
    width:40px; height:40px; border-radius:50%;
    background:#2a2d33; border:1px solid var(--cardBorder);
    display:grid; place-items:center; box-shadow:0 6px 18px rgba(0,0,0,.34)
  }
  .swap svg{width:20px;height:20px}
  .swap svg path{stroke:var(--accent); fill:none; stroke-width:1.8; stroke-linecap:round; stroke-linejoin:round}

  .cta{margin-top:22px}
  .cta button{width:100%; height:60px; border-radius:34px; border:0; cursor:pointer; background:var(--accent); color:#fff; font-weight:800; font-size:24px; letter-spacing:.2px; box-shadow:0 12px 26px rgba(30,139,255,.33); transition:transform var(--t), background var(--t)}
  .cta button:hover{background:var(--accentHover)}
  .cta button:active{transform:translateY(1px)}

  /* ---------- OVERLAY ---------- */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:opacity var(--t);}
  .backdrop.show{opacity:1; pointer-events:auto}
  .sheet{position:fixed; left:50%; transform:translate(-50%, 100%); bottom:0; width:min(420px,96vw); max-height:86vh; background:var(--card); border:1px solid var(--cardBorder); border-radius:28px 28px 0 0; box-shadow:0 -18px 48px rgba(0,0,0,.6); overflow:hidden; transition:transform var(--t)}
  .sheet.show{transform:translate(-50%,0)}
  .sheet-header{position:sticky; top:0; background:linear-gradient(180deg, rgba(0,0,0,.22), transparent 70%), var(--card); padding:14px 16px 8px; z-index:2; display:flex; align-items:center; justify-content:center;}
  .route-title{font-weight:800; letter-spacing:.4px}
  .btn-back{position:absolute; left:10px; top:10px; width:36px; height:36px; border-radius:50%; border:1px solid var(--cardBorder); background:#2a2d33; display:grid; place-items:center}
  .btn-back svg{width:18px;height:18px}

  .view{padding:12px 16px 22px; max-height:calc(86vh - 76px); overflow:auto; animation:fadeSlideIn .28s var(--t) both;}
  @keyframes fadeSlideIn {from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:none}}

  .results{padding:10px 12px 18px;}
  .card-result{background:#22252a; border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:16px 16px 14px; margin:12px 4px; box-shadow:0 8px 24px rgba(0,0,0,.35); transition:transform var(--t), box-shadow var(--t), background var(--t)}
  .card-result:active{transform:translateY(1px); box-shadow:0 6px 18px rgba(0,0,0,.28); background:#202228}
  .row-top{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .pair{display:flex; align-items:baseline; gap:10px}
  .code{font-weight:800; letter-spacing:.6px; color:#ddd}
  .timepair{font-size:20px; font-weight:800; letter-spacing:.2px}
  .plus1{font-size:14px; color:var(--muted); margin-left:2px}
  .right-price{font-weight:800; font-size:20px; color:#2ea0ff; display:flex; align-items:center; gap:6px}
  .row-mid{color:var(--muted); margin:6px 0 0; display:flex; gap:14px; font-size:15px}
  .row-foot{margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,.06); display:flex; align-items:center; gap:8px; color:#ffcc66; font-size:14px}
  .row-foot.hide{display:none}

  .panel{background:#23262c; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px 14px 12px; margin:10px 0; box-shadow:0 8px 22px rgba(0,0,0,.32)}
  .panel h3{margin:0 0 8px; font-size:20px}
  .kv{display:flex; justify-content:space-between; margin:6px 0; color:#cfd6dd; gap:12px}
  .kv b{color:#fff}
  .btn-lg{width:100%; height:56px; border-radius:30px; border:0; background:var(--accent); color:#fff; font-weight:800; font-size:20px; box-shadow:0 10px 24px rgba(30,139,255,.33); cursor:pointer; transition:transform var(--t), background var(--t)}
  .btn-lg:active{transform:translateY(1px)}

  .info{background:#1d3a54; border:1px solid rgba(67,153,255,.4)}
  .info .title{font-weight:800; margin-bottom:8px}
  .muted{color:#aab2ba}

  .form-row{display:grid; gap:12px; grid-template-columns:1fr; width:100%}
  .form-row.half{grid-template-columns:repeat(2, minmax(0,1fr))}
  @media (max-width: 360px){ .form-row.half{grid-template-columns:1fr} }
  .field{display:flex; flex-direction:column; gap:6px; min-width:0}
  .field label{color:#c8ced6; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .field input, .field select{width:100%; max-width:100%; background:#121317; color:#fff; border:1px solid rgba(255,255,255,.16); border-radius:12px; padding:12px 12px; font-size:16px; outline:none; -webkit-appearance:none; appearance:none;}
  .agree{display:flex; align-items:flex-start; gap:10px; margin:12px 0 8px; color:#cfd6dd}
  .agree input{margin-top:4px}

  @media (min-width:480px){ .sheet, .page{width:420px} }

  .hr{height:1px;background:rgba(255,255,255,.14); margin:8px 0}

  :root { --priceGreen:#63d488; }

  .gf-head{display:flex;align-items:center;justify-content:space-between}
  .gf-times{font-size:20px;font-weight:800;letter-spacing:.2px}
  .gf-times .arrow{opacity:.6;margin:0 8px}
  .gf-times sup{font-size:12px; color:var(--muted); margin-left:4px}
  .gf-iata{margin-top:2px;font-size:12px;color:#9aa3af;letter-spacing:.2px}
  .gf-meta{margin-top:6px;font-size:14px;color:#cfd6dd}
  .gf-meta .dot{opacity:.6;margin:0 6px}
  .gf-carrier{margin-top:2px;font-size:14px;color:#aab2ba}
  .gf-price{font-weight:800;font-size:20px;color:var(--priceGreen)}
  .gf-overnight{margin-top:8px;color:#ffcc66;font-size:14px;display:flex;align-items:center;gap:6px}

/* === ATC24 toggle + chip + filter UI === */
.head-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; margin:0 4px 8px;
}
.mini-icon-btn{
  display:inline-grid; place-items:center;
  width:36px; height:36px; border-radius:10px;
  background:#2a2d33; border:1px solid rgba(255,255,255,.12);
  cursor:pointer;
}
.mini-icon-btn svg{ width:18px; height:18px }
.mini-icon-btn svg *{ stroke:#cfd6dd; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round }

/* tiny slider */
.atc24-toggle{
  display:flex; align-items:center; justify-content:flex-end;
  margin:10px 2px -2px;       /* tucks in under the price panel */
}
.tiny-switch{
  display:inline-flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.2px;
}
.tiny-switch input{ position:absolute; opacity:0; pointer-events:none }
.tiny-track{
  width:42px; height:24px; border-radius:999px; position:relative;
  background:#444a52; border:1px solid rgba(255,255,255,.16);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
  transition: background var(--t), border-color var(--t);
}
.tiny-knob{
  position:absolute; top:50%; left:3px; width:18px; height:18px; border-radius:50%;
  transform:translateY(-50%); background:#fff; transition:left var(--t);
  box-shadow:0 2px 6px rgba(0,0,0,.35);
}
.tiny-switch input:checked + .tiny-track{
  background:rgba(33,208,122,.35); border-color:rgba(33,208,122,.55);
}
.tiny-switch input:checked + .tiny-track .tiny-knob{ left:21px; }

/* white ATC24 “chip” used in many places */
.chip-atc24{
  display:inline-block; background:#fff; color:#111; font-weight:900;
  padding:4px 8px; border-radius:8px; letter-spacing:.3px;
  box-shadow:0 1px 0 rgba(0,0,0,.35);
}
.chip-atc24.big{ padding:6px 10px; border-radius:10px; font-size:22px }

/* banner at top of trip detail when ATC24 */
.atc24-banner{
  display:flex; justify-content:center; align-items:center;
  width:120px; margin:0 4px 12px; background:#fff; color:#111;
  font-weight:900; padding:8px 10px; border-radius:10px; letter-spacing:.3px;
}

/* centered Filter modal (re-uses your visual language) */
.flt-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  opacity:0; pointer-events:none; transition:opacity var(--t); z-index:1400;
}
.flt-backdrop.show{ opacity:1; pointer-events:auto }
.flt-modal{
  position:fixed; left:50%; top:50%;
  transform:translate(-50%,-40%) scale(.96); opacity:0;
  width:min(360px, 92vw); background:var(--card); border:1px solid var(--cardBorder);
  border-radius:16px; box-shadow:0 22px 60px rgba(0,0,0,.65);
  padding:14px; transition:transform var(--t), opacity var(--t); z-index:1401;
}
.flt-modal.show{ transform:translate(-50%,-50%) scale(1); opacity:1 }
.flt-modal h3{ margin:6px 0 10px; font-size:18px; font-weight:800 }
.flt-options{ display:grid; gap:8px; }
.flt-opt{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer;
  background:#2a2d33; border:1px solid rgba(255,255,255,.12);
}
.flt-opt input{ width:18px; height:18px }
.flt-btns{ display:flex; gap:10px; margin-top:12px }
.flt-apply{ flex:1; height:48px; border-radius:12px; border:0; background:var(--accent); color:#fff; font-weight:900; cursor:pointer }

/* Make Upcoming Trips same size as Previous Trips */
#screen-trips h1{ font-size:22px; font-weight:800; margin:14px 4px 10px; letter-spacing:.2px }
  
  /* ---- Processing / Confirmation bits ---- */
  .processing { display:grid; gap:14px; place-items:center; padding:40px 8px; text-align:center; }
  .spinner { width:52px; height:52px; border-radius:50%; border:4px solid rgba(255,255,255,.18); border-top-color: var(--accent); animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .glass { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); border-radius: 18px; padding:16px 14px 12px; box-shadow: 0 10px 28px rgba(0,0,0,.35); backdrop-filter: blur(6px); }

  .check-wrap{ width:72px;height:72px; border-radius:50%; background: rgba(68, 185, 119, .15); display:grid; place-items:center; margin:0 auto 10px; border:1px solid rgba(68,185,119,.25); }
  .check-wrap svg{width:40px;height:40px}
  .check-wrap svg *{stroke:#63d488; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round}

  .confirm-title{font-weight:800; font-size:20px; text-align:center; margin:6px 0 2px}
  .confirm-sub{color:#cfd6dd; text-align:center; margin-bottom:10px}

  .badge { display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.12); font-weight:700; letter-spacing:.3px; }
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

  .icon { pointer-events: none; }
  .select .icon { pointer-events: none; }
  .swap { pointer-events: none; }

  .select select {
    position: relative;
    z-index: 1;
    -webkit-appearance: none;
    appearance: none;
  }

  /* modal layer order + lock the page when sheet is open */
.backdrop { z-index: 999; }
.sheet    { z-index: 1000; }

.modal-open { overflow: hidden; }        /* no background scroll */
.modal-open .page { pointer-events: none; } /* no background taps/clicks */

  /* ---- Bottom Dock (tabs) ---- */
.dock{
  position:fixed;
  left:50%;
  bottom:calc(12px + env(safe-area-inset-bottom));
  transform:translateX(-50%);
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:1fr;
  gap:6px;
  padding:6px;
  width:min(360px, 92vw);
  border-radius:999px;
  background:rgba(20,22,26,.72);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 10px 30px rgba(0,0,0,.45);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  z-index:5; /* stays under the sheet/backdrop */
  --tabs:4;
}
.dock-item{
  position:relative; z-index:1;
  display:flex; align-items:center; justify-content:center; gap:8px;
  height:44px; padding:0 16px;
  border:0; background:transparent; cursor:pointer;
  color:var(--muted); font-weight:800; letter-spacing:.2px;
  border-radius:999px; transition:color var(--t);
}
.dock-item.active{ color:#fff; }
.dock-item svg{width:18px; height:18px}
.dock-item svg *{stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round}

.dock-indicator{
  position:absolute; top:6px; bottom:6px; left:6px;
  width: calc((100% / var(--tabs, 4)) - 3px);
  border-radius:999px;
  background:rgba(30,139,255,.18);
  border:1px solid rgba(30,139,255,.45);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
  transform:translateX(0%); transition:transform var(--t);
  will-change:transform;
}
  
/* (optional) make sure sheet/backdrop are above the dock */
.backdrop{ z-index:40; }
.sheet{ z-index:50; }

  /* Screens + simple fade/slide transition */
.screen{
  opacity:0; transform:translateY(8px);
  transition:opacity var(--t), transform var(--t);
}
.screen.show{ opacity:1; transform:none; }

/* small section header for "Previous Trips" */
.subhead{ font-size:20px; font-weight:800; margin:8px 4px 0; }

  .gf-times{font-size:18px; line-height:1.15; font-weight:800; letter-spacing:.2px}
  .gf-times sup{font-size:11px}

  /* Airline logo row */
.row-mid{
  display:flex; align-items:center; gap:10px;
  color:var(--muted); margin:6px 0 0; font-size:15px;
}
.airlogo{
  width:22px; height:22px; object-fit:contain; flex:0 0 22px;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,.35));
}
.airlogo.is-u2{ width:26px; height:26px; }  /* easyJet slightly bigger */
.row-mid-text .carrier-line{ color:#cfd6dd; font-size:14px; margin-top:2px; }

  /* ------- Trips page ------- */
.subhead{font-size:22px;font-weight:800;margin:14px 4px 10px}
.trip-list{display:grid;gap:12px;padding:0 4px 24px}
.trip-card{
  display:flex;gap:12px;align-items:center;
  background:#202329;border:1px solid rgba(255,255,255,.10);
  border-radius:16px;padding:12px 12px;box-shadow:0 8px 22px rgba(0,0,0,.32);
  transition:transform var(--t), box-shadow var(--t), background var(--t)
}
.trip-card:active{transform:translateY(1px);box-shadow:0 6px 18px rgba(0,0,0,.28);background:#1f2127}
.trip-logo{width:34px;height:34px;border-radius:8px;object-fit:contain;background:#13151a;display:block}
.trip-body{display:grid;gap:4px;min-width:0}
.trip-times{font-size:18px;font-weight:800;letter-spacing:.2px}
.trip-route{font-size:13px;color:#aab2ba}
.trip-date{font-size:12px;color:#8f99a4}

.pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;letter-spacing:.3px}
.pill-ontime{background:rgba(33,208,122,.15);border:1px solid rgba(33,208,122,.35);color:#63d488}
.pill-inflight{background:rgba(67,153,255,.15);border:1px solid rgba(67,153,255,.33);color:#2ea0ff}
.pill-arrived{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:#d9dee3}

.t-early{color:#63d488}
.t-late{color:#ff6b6b}

/* small action sheet used by Status button */
.actions-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity var(--t)}
.actions-backdrop.show{opacity:1;pointer-events:auto}
.actions{
  position:fixed;left:50%;bottom:0;transform:translate(-50%,20px);
  width:min(420px,96vw);background:var(--card);border:1px solid var(--cardBorder);
  border-radius:18px 18px 0 0;box-shadow:0 -16px 36px rgba(0,0,0,.55);padding:10px 12px 12px;
  transition:transform var(--t)
}
.actions.show{transform:translate(-50%,0)}
.actions .btn{width:100%;height:48px;border:0;border-radius:12px;background:#2a2d33;color:#fff;font-weight:700;margin:6px 0}
.actions .btn.red{background:#5a1e1e}
.actions .row{display:grid;gap:8px;margin:8px 0}
.actions input[type="time"], .actions input[type="text"]{
  width:100%;background:#121317;border:1px solid rgba(255,255,255,.16);color:#fff;border-radius:12px;padding:10px 12px;font-size:16px
}

/* Trips page container (hidden when on booking) */
#pageTrips[hidden]{display:none}

  /* ---- Trip detail (full page) ---- */
.btn-page-back{
  position:absolute; left:12px; top:12px; width:36px; height:36px;
  border-radius:50%; border:1px solid var(--cardBorder);
  background:#2a2d33; display:grid; place-items:center; z-index:2
}
.btn-page-back svg{width:18px;height:18px}

.td-topnote{color:#9aa3af; font-size:12px; margin:0 4px 4px}
.td-title{font-size:44px; font-weight:800; letter-spacing:.3px; margin:22px 4px 12px}
@media (max-width:380px){ .td-title{font-size:38px} }

.td-card{
  background:#202329; border:1px solid rgba(255,255,255,.10);
  border-radius:18px; padding:14px 14px 12px; margin:10px 0;
  box-shadow:0 8px 22px rgba(0,0,0,.32);
}
.td-airlineRow{display:flex; align-items:center; justify-content:space-between; gap:12px}
.td-left{display:flex; align-items:center; gap:12px}
.td-logo{width:40px; height:40px; border-radius:10px; background:#13151a; object-fit:contain}
.td-airlineName{font-weight:800; font-size:18px}
.td-route{font-size:13px; color:#aab2ba}

/* reuse your .kv rows */

  /* small action sheet used by Status button */
.actions-backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  opacity:0; pointer-events:none; transition:opacity var(--t);
  z-index:1100;                    /* ABOVE the dock */
}
.actions-backdrop.show{ opacity:1; pointer-events:auto }

.actions{
  position:fixed; left:50%; bottom:0;
  transform:translate(-50%, 100%); /* start fully off-screen */
  width:min(420px,96vw);
  background:var(--card); border:1px solid var(--cardBorder);
  border-radius:18px 18px 0 0; box-shadow:0 -16px 36px rgba(0,0,0,.55);
  padding:10px 12px calc(12px + env(safe-area-inset-bottom)); /* clear iOS bar */
  transition:transform var(--t);
  z-index:1101;                    /* ABOVE the backdrop & dock */
}
.actions.show{ transform:translate(-50%, 0) }

.actions .btn{ width:100%; height:48px; border:0; border-radius:12px;
  background:#2a2d33; color:#fff; font-weight:700; margin:6px 0 }
.actions .btn.red{ background:#5a1e1e }

.actions .row{ display:grid; gap:8px; margin:8px 0 }
.actions input[type="time"], .actions input[type="text"]{
  width:100%; background:#121317; border:1px solid rgba(255,255,255,.16);
  color:#fff; border-radius:12px; padding:10px 12px; font-size:16px
}

/* also block taps on the dock while any modal/action is open */
.modal-open .dock{ pointer-events:none; }

  /* ---- Delete button in archived cards ---- */
.trip-right{ margin-left:auto; display:grid; gap:6px; align-items:center; justify-items:end }
.mini-btn{
  height:32px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14);
  background:#2a2d33; color:#fff; font-weight:700; cursor:pointer; transition:transform var(--t), background var(--t)
}
.mini-btn.red{ background:#5a1e1e; border-color:rgba(255,99,99,.45) }
.mini-btn:active{ transform:translateY(1px) }

/* ---- Centered confirm dialog ---- */
.confirm-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  opacity:0; pointer-events:none; transition:opacity var(--t); z-index:1200;
}
.confirm-backdrop.show{ opacity:1; pointer-events:auto }

.confirm{
  position:fixed; left:50%; top:50%;
  transform:translate(-50%,-40%) scale(.96); opacity:0;
  width:min(420px, 90vw); background:var(--card); border:1px solid var(--cardBorder);
  border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.6);
  padding:16px; transition:transform var(--t), opacity var(--t); z-index:1201;
}
.confirm.show{ transform:translate(-50%,-50%) scale(1); opacity:1 }
.confirm h3{ margin:6px 0 4px; font-size:18px; font-weight:800 }
.confirm p{ margin:0 0 12px; color:#cfd6dd }
.confirm .row-btns{ display:flex; gap:10px; margin-top:10px }
.btn-outline{
  flex:1; height:44px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
  background:#2a2d33; color:#fff; font-weight:700; cursor:pointer;
}
.btn-danger{
  flex:1; height:44px; border-radius:12px; border:1px solid rgba(255,99,99,.45);
  background:#5a1e1e; color:#fff; font-weight:800; cursor:pointer;
}

/* block dock while any modal is open (you already have .modal-open for sheets) */
.modal-open .dock{ pointer-events:none; }

  /* ---- Trip detail (large-times design) ---- */
.tdetail .updated{color:#8f99a4;font-size:12px;margin:2px 4px 12px}
.tdetail .route{font-size:40px;line-height:1.05;font-weight:800;letter-spacing:.4px;margin:0 4px 14px}

.tcard{
  background:#202329;border:1px solid rgba(255,255,255,.10);
  border-radius:20px;padding:14px 14px;box-shadow:0 10px 28px rgba(0,0,0,.35);
  margin:10px 0
}
.trow{display:flex;align-items:center;gap:12px}
.trow .airline{font-weight:800;font-size:20px}
.trow .sub{color:#aab2ba;font-size:13px;margin-top:2px}
.trow .pill{margin-left:auto}

.section{padding:14px 14px 12px}
.airport{font-weight:700}
.airport small{color:#9aa3af;font-weight:600}
.bigtime{font-size:44px;line-height:1.02;font-weight:900;letter-spacing:.4px;margin:8px 0 0}
.sched-old{margin-left:10px;text-decoration:line-through;opacity:.45;font-weight:700}
.delta{font-weight:800;margin-top:4px}
.delta.late{color:#ff6b6b}
.delta.early{color:#63d488}

.tfooter{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.tfooter .kv{margin:0}

/* gate badge + terminal label */
.headrow{display:flex;align-items:center;justify-content:space-between}
.gatebox{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.gatepill{
  display:inline-block; padding:6px 10px; border-radius:10px;
  background:#ffd54a; color:#111; font-weight:900; letter-spacing:.2px;
}
.term{font-size:12px; color:#cfd6dd}

/* color the NEW time when early/late (not the crossed-out one) */
.time-early{color:#63d488; font-weight:900}
.time-late {color:#ff6b6b; font-weight:900}

  /* ---- CBP (arrival) modal ---- */
.cbp-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  opacity:0; pointer-events:none; transition:opacity var(--t); z-index:1300;
}
.cbp-backdrop.show{ opacity:1; pointer-events:auto }

.cbp-modal{
  position:fixed; left:50%; top:10px;
  transform:translate(-50%, calc(100% + 12px));
  width:min(420px,96vw); max-height:calc(100vh - 20px);
  background:var(--card); border:1px solid var(--cardBorder);
  border-radius:20px; overflow:hidden; box-shadow:0 22px 60px rgba(0,0,0,.65);
  transition:transform var(--t); z-index:1301;
}
.cbp-modal.show{ transform:translate(-50%, 0) }

.cbp-head{ display:grid; gap:10px; padding:14px 14px 10px }
.cbp-head img{ width:44px; height:44px; object-fit:contain; filter:drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
.cbp-hr{ height:1px; background:rgba(255,255,255,.14) }

.cbp-body{ padding:14px; display:grid; gap:12px }
.cbp-title{ font-size:24px; font-weight:900; letter-spacing:.3px; margin-top:2px }
.cbp-row{ display:grid; gap:8px }
.cbp-row label{ color:#c8ced6; font-size:14px }
.cbp-row input, .cbp-row select{
  width:100%; background:#121317; color:#fff; border:1px solid rgba(255,255,255,.16);
  border-radius:12px; padding:10px 12px; font-size:16px; outline:none; -webkit-appearance:none; appearance:none;
}

  /* ====== Stats screen ====== */
.stat-card{
  position:relative;
  border-radius:18px;
  padding:18px 16px;
  margin:12px 4px;
  box-shadow:0 10px 28px rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.stat-card .stat-kicker{
  font-weight:800; letter-spacing:.3px; opacity:.95; margin-bottom:8px;
}
.stat-card .stat-big{
  font-size:36px; line-height:1; font-weight:900; letter-spacing:.3px;
}
.stat-card .stat-sub{
  margin-top:6px; color:#d0d7df; font-size:14px;
}

/* gradients */
.grad-blue{
  background:linear-gradient(135deg, rgba(30,139,255,.22), rgba(30,139,255,.06));
}
.grad-red{
  background:linear-gradient(135deg, rgba(255,88,88,.22), rgba(255,88,88,.06));
}
.grad-ice{
  background:linear-gradient(135deg, rgba(255,255,255,.18), rgba(130,190,255,.12));
}

/* most-flown aircraft logo spot (bottom-right) */
.stat-logo{
  position:absolute; right:10px; bottom:10px;
  width:44px; height:44px; border-radius:10px;
  background:#13151a; object-fit:contain;
  filter:drop-shadow(0 1px 0 rgba(0,0,0,.35));
  display:none;
}

  /* ===== ID page (Travel identification) ===== */
.id-hr{height:1px;background:rgba(255,255,255,.14);margin:8px 4px 14px}

.id-card{
  position:relative;
  background:linear-gradient(180deg,#0f1115, #1a1d23);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:16px 16px 14px;
  box-shadow:0 10px 28px rgba(0,0,0,.35);
  margin:10px 4px;
}
.id-card .title{font-size:18px;font-weight:900;letter-spacing:.3px;margin-bottom:8px}
.id-card .row{display:grid;gap:4px}
.id-card .label{color:#aab2ba;font-size:12px}
.id-card .value{font-weight:800;font-size:18px;letter-spacing:.3px}
.id-card .value.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}

/* Passport look */
.id-card.passport{
  background:linear-gradient(160deg,#0c0d10 0%, #23262c 100%);
  border-color:rgba(255,255,255,.18);
}

/* VISA card look */
.id-card.visa{
  background:linear-gradient(160deg,#0d1621 0%, #1f2f44 100%);
  border-color:rgba(67,153,255,.35);
}
.id-card.visa .title{
  font-style:italic; font-weight:900;
}

/* VISA status pill (bottom-right) */
.visa-status{
  position:absolute; right:12px; bottom:12px;
  padding:6px 10px; border-radius:999px; font-weight:900; letter-spacing:.2px;
  background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16);
}
.visa-status.active{ color:#63d488; border-color:rgba(33,208,122,.35); background:rgba(33,208,122,.12) }
.visa-status.expired{ color:#ff6b6b; border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.10) }

/* VISA countdown (top-right) */
.visa-timer{
  position:absolute; right:12px; top:12px;
  font-weight:800; letter-spacing:.3px;
  background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16);
  padding:6px 10px; border-radius:10px;
}

/* small warning banner shown if redirected here */
.id-warn{
  background:#3b2a2a; border:1px solid rgba(255,99,99,.35);
  color:#ffd0d0; border-radius:12px; padding:10px 12px; margin:8px 4px 10px; display:none;
  font-weight:700;
}
.id-warn.show{ display:block }

/* Centered modal for VISA */
.idv-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  opacity:0; pointer-events:none; transition:opacity var(--t); z-index:1400;
}
.idv-backdrop.show{ opacity:1; pointer-events:auto }

.idv-modal{
  position:fixed; left:50%; top:50%;
  transform:translate(-50%,-40%) scale(.96); opacity:0;
  width:min(420px, 92vw); background:var(--card); border:1px solid var(--cardBorder);
  border-radius:16px; box-shadow:0 22px 60px rgba(0,0,0,.65);
  transition:transform var(--t), opacity var(--t); z-index:1401; padding:14px;
}
.idv-modal.show{ transform:translate(-50%,-50%) scale(1); opacity:1 }
.idv-modal h3{ margin:6px 0 4px; font-size:20px; font-weight:900 }
.idv-modal .sub{ color:#cfd6dd; margin-bottom:10px }
.idv-row{ display:grid; gap:8px; margin:8px 0 }
.idv-row .field{ display:flex; flex-direction:column; gap:6px }
.idv-row .field label{ color:#c8ced6; font-size:14px }
.idv-row .field input{
  width:100%; background:#121317; color:#fff; border:1px solid rgba(255,255,255,.16);
  border-radius:12px; padding:10px 12px; font-size:16px; outline:none; -webkit-appearance:none; appearance:none;
}
.idv-btns{ display:flex; gap:10px; margin-top:10px }
.idv-btn{ flex:1; height:48px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
  background:#2a2d33; color:#fff; font-weight:800; cursor:pointer }
.idv-btn.primary{ background:var(--accent); border-color:rgba(30,139,255,.4) }

  /* ==== CBP hub card & page ==== */
.cbp-hub{
  background:linear-gradient(135deg, rgba(255,255,255,.22), rgba(130,190,255,.12));
  display:flex; gap:12px; align-items:center; min-height:92px;
}
.cbp-badge{ width:42px; height:42px; object-fit:contain; filter:drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
.cbp-hub .title{ font-weight:900; font-size:18px; }
.cbp-go{
  margin-left:auto; height:38px; padding:0 14px; border-radius:12px;
  border:1px solid rgba(255,255,255,.16); background:#2a2d33; color:#fff;
  font-weight:800; cursor:pointer;
}

.cbp-logo-big{
  width:92px; height:92px; object-fit:contain;
  display:block; margin:0 auto 6px; filter:drop-shadow(0 1px 0 rgba(0,0,0,.35));
}
.cbp-empty{ text-align:center; color:#cfd6dd; margin:8px 0 14px; }
.cbp-bigbtn{
  width:100%; height:52px; border-radius:14px; border:0;
  background:var(--accent); color:#fff; font-weight:800; font-size:18px;
  box-shadow:0 10px 24px rgba(30,139,255,.33); cursor:pointer;
}

/* “Saved form …” selectable chip shown in the Trips CBP modal */
.cbp-saved{
  padding:10px 12px; border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  cursor:pointer;
}
.cbp-saved.selected{
  border-color:rgba(30,139,255,.5);
  box-shadow:0 0 0 2px rgba(30,139,255,.35) inset;
}

.cbp-question{
  font-size:22px;
  font-weight:900;
  letter-spacing:.2px;
}

</style>
</head>
<body>
  <main id="screen-booking" class="page screen show">
    <h1>Book</h1>

    <section class="card" aria-label="Flight Search">
      <div class="swap" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M3 7h12"></path><path d="M10 3l5 4-5 4"></path><path d="M21 17H9"></path><path d="M14 21l-5-4 5-4"></path></svg>
      </div>

      <div class="grid">
        <div class="row">
          <div class="label">From</div>
          <div class="line-wrap select">
            <select id="from" aria-label="From">
              <option value="" selected disabled>City / airport</option>
            </select>
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4.5 12.8l14.6-8.75c.5-.3 1.1.23.83.76L13.6 20.9a.7.7 0 0 1-1.31-.06l-1.24-5.17-5.17-1.24a.7.7 0 0 1 .06-1.31z"></path></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>

        <div class="row">
          <div class="label">To</div>
          <div class="line-wrap select">
            <select id="to" aria-label="To">
              <option value="" selected disabled>City / airport</option>
            </select>
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4.5 12.8l14.6-8.75c.5-.3 1.1.23.83.76L13.6 20.9a.7.7 0 0 1-1.31-.06l-1.24-5.17-5.17-1.24a.7.7 0 0 1 .06-1.31z"></path></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>

        <div class="row">
          <div class="label">Depart</div>
          <div class="line-wrap">
            <input id="depart" class="input" type="date" aria-label="Depart date" />
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="16" rx="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="8" y1="3" x2="8" y2="7"></line><line x1="16" y1="3" x2="16" y2="7"></line></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>
        
        <div class="row">
          <div class="label">Return</div>
          <div class="line-wrap">
            <input id="return" class="input" type="date" aria-label="Return date (ignored for one-way)" />
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="16" rx="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="8" y1="3" x2="8" y2="7"></line><line x1="16" y1="3" x2="16" y2="7"></line></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>

        <div class="row">
          <div class="label">Passengers</div>
          <div class="line-wrap select">
            <select id="pax" aria-label="Passengers">
              <option selected>1</option><option>2</option><option>3</option>
              <option>4</option><option>5</option><option>6</option>
            </select>
            <div class="focusbar"></div>
          </div>
        </div>
      </div>

      <div class="cta"><button id="btnSearch" type="button">Search</button></div>
    </section>
  </main>

  <div class="backdrop" id="backdrop"></div>
  <section class="sheet" id="sheet" aria-modal="true" role="dialog">
    <div class="sheet-header">
      <button class="btn-back" id="btnBack" aria-label="Back">
        <svg viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" stroke="#9aa3af" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="route-title" id="routeTitle">RFD – PER</div>
    </div>
    <div id="sheetBody" class="view"></div>
  </section>

  <main id="screen-trips" class="page screen" style="display:none">
  <div class="head-row">
  <h1>Upcoming Trips</h1>
  <button class="mini-icon-btn" id="btnTripsFilter" type="button" aria-label="Filter trips">
    <svg viewBox="0 0 24 24">
      <path d="M3 5h18M6 12h12M10 19h4"></path>
    </svg>
  </button>
</div>
  <div id="upcomingEmpty" class="muted" style="margin:2px 4px 12px">No upcoming trips</div>
  <div id="upcomingList" class="trip-list"></div>
  <div class="hr" style="margin:12px 0"></div>
  <div class="subhead">Previous Trips</div>
  <div id="previousList" class="trip-list"></div>
</main>

  <main id="screen-trip-detail" class="page screen" style="display:none"></main>

  <main id="screen-stats" class="page screen" style="display:none">
  <div class="head-row">
  <h1>Statistics</h1>
  <button class="mini-icon-btn" id="btnStatsFilter" type="button" aria-label="Filter statistics">
    <svg viewBox="0 0 24 24">
      <path d="M3 5h18M6 12h12M10 19h4"></path>
    </svg>
  </button>
</div>
  <div class="hr" style="margin:8px 4px 12px"></div>

  <section class="stat-card grad-blue">
    <div class="stat-kicker">Flight time</div>
    <div class="stat-big" id="statFlightTimeValue">0h 0m</div>
  </section>

  <section class="stat-card grad-blue">
    <div class="stat-kicker">IRL time</div>
    <div class="stat-big" id="statIrlTimeValue">0h 0m</div>
  </section>

  <section class="stat-card grad-red">
    <div class="stat-big" id="statDelayHoursValue">0</div>
    <div class="stat-sub">hours lost from delays</div>
  </section>

  <section class="stat-card grad-ice">
    <div class="stat-kicker">Most flown aircraft</div>
    <div class="stat-big" id="statMostAircraft">—</div>
    <img id="statMostAircraftLogo" class="stat-logo" alt="">
  </section>
</main>

<!-- CBP Page (no dock tab) -->
<main id="screen-cbp" class="page screen" style="display:none">
  <img class="cbp-logo-big" src="./cbp-icon.png" alt="CBP">
  <div id="cbpContent"></div>
</main>

<nav class="dock" id="dock" aria-label="Tabs">
  <span class="dock-indicator" aria-hidden="true"></span>

  <button class="dock-item active" data-tab="booking" aria-current="page">
    <svg viewBox="0 0 24 24">
      <path d="M4.5 12.8l14.6-8.75c.5-.3 1.1.23.83.76L13.6 20.9a.7.7 0 0 1-1.31-.06l-1.24-5.17-5.17-1.24a.7.7 0 0 1 .06-1.31z"></path>
    </svg>
    <span>Booking</span>
  </button>

  <button class="dock-item" data-tab="trips">
    <svg viewBox="0 0 24 24">
      <rect x="3" y="4" width="18" height="16" rx="3"></rect>
      <path d="M7 8h10M7 12h10M7 16h7"></path>
    </svg>
    <span>Trips</span>
  </button>

  <!-- Stats goes INSIDE the nav (3rd) -->
  <button class="dock-item" data-tab="stats">
    <svg viewBox="0 0 24 24">
      <path d="M4 20V10"></path>
      <path d="M10 20V4"></path>
      <path d="M16 20v-6"></path>
      <path d="M3 20h18"></path>
    </svg>
    <span>Stats</span>
  </button>

  <!-- ID stays 4th -->
  <button class="dock-item" data-tab="id">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="6" width="18" height="12" rx="2"></rect>
      <circle cx="9" cy="12" r="2"></circle>
      <path d="M13 10h5M13 13h5"></path>
    </svg>
    <span>ID</span>
  </button>
</nav>

  <main id="screen-id" class="page screen" style="display:none">
  <h1>Travel identification</h1>
  <div class="id-hr"></div>

  <!-- shown when redirected here from blocked search -->
  <div id="visaWarn" class="id-warn">Active VISA required for travel to Japan.</div>

  <!-- Passport card -->
  <section class="id-card passport" aria-label="Passport">
    <div class="title">Passport</div>
    <div class="row">
      <div class="label mono">Number</div>
      <div class="value mono">457476810</div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="label">Name</div>
      <div class="value">Shloak Patel</div>
    </div>
  </section>

  <!-- VISA card container (rendered by JS) -->
  <section id="visaCardMount"></section>
    <!-- CBP hub card (launches the CBP page) -->
<section class="id-card cbp-hub grad-ice">
  <img class="cbp-badge" src="./cbp-icon.png" alt="CBP">
  <div class="title">CBP</div>
  <button class="cbp-go" id="btnCBPPage" type="button">CBP Submissions</button>
</section>
</main>

<script>
/* -------------------- Airports + form behavior -------------------- */
const AIRPORTS = [
  { code:'RFD', name:'Rockford Intl Airport (RFD)' },
  { code:'MLR', name:'Mellor Regional Airport (MLR)' },
  { code:'PER', name:'Perth Intl Airport (PER)' },
  { code:'IZO', name:'Izolirani Intl Airport (IZO)' },
  { code:'LCA', name:'Larnaca Intl Airport (LCA)' },
  { code:'PHP', name:'Phaphos Regional Airport (PHP)' },
  { code:'HND', name:'Tokyo Haneda Intl (HND)' },
  { code:'GRV', name:'Grindavik Intl Airport (GRV)' },
  { code:'SAU', name:'Sauthemptona Airport (SAU)' }
];

let passengerData = {};
function randDigits(n){ let s=''; for(let i=0;i<n;i++) s += Math.floor(Math.random()*10); return s; }
function formatDate(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }

const fromSel = document.getElementById('from');
const toSel   = document.getElementById('to');

function fillSelect(selectEl, excludeCode) {
  const current = selectEl.value;
  selectEl.innerHTML = '<option value="" disabled selected>City / airport</option>';
  AIRPORTS.forEach(a => {
    if (a.code !== excludeCode) {
      const opt = document.createElement('option');
      opt.value = a.code; opt.textContent = a.name;
      selectEl.appendChild(opt);
    }
  });
  if (current && current !== excludeCode) {
    const exists = Array.from(selectEl.options).some(o => o.value === current);
    if (exists) selectEl.value = current;
  }
}
fillSelect(fromSel);
fillSelect(toSel);
fromSel.addEventListener('change', () => fillSelect(toSel, fromSel.value || null));
toSel  .addEventListener('change', () => fillSelect(fromSel, toSel.value || null));

/* -------------------- Overlay + transitions -------------------- */
const backdrop = document.getElementById('backdrop');
const sheet = document.getElementById('sheet');
const btnBack = document.getElementById('btnBack');
const sheetBody = document.getElementById('sheetBody');
const routeTitle = document.getElementById('routeTitle');
let stepStack = [];

  /* ---- ATC24 + filters state ---- */
let currentTripsFilter = 'all';   // 'all' | 'regular' | 'atc24'
let currentStatsFilter = 'all';   // 'all' | 'regular' | 'atc24'

function applyFilter(arr, mode){
  if (mode === 'all') return arr;
  if (mode === 'atc24') return arr.filter(t => !!t.atc24);
  /* regular */          return arr.filter(t => !t.atc24);
}

/* ---- inflight stopwatch (persists in localStorage) ---- */
let inflightInterval = null;

function formatHMS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
const CLOCK_SVG = `<svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
  <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.8"/>
  <path d="M12 7v5l3 2" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;

function renderInflightTimer(slotEl, trip){
  if(!slotEl) return;
  slotEl.innerHTML = '';
  if(!trip.inflightStart) return;

  const wrap = document.createElement('span');
  wrap.className = 'badge';
  wrap.style.display = 'inline-flex';
  wrap.style.alignItems = 'center';
  wrap.style.gap = '6px';
  wrap.innerHTML = `${CLOCK_SVG}<span class="mono" id="sw-${trip.id}"></span>`;
  slotEl.appendChild(wrap);

  const label = wrap.querySelector(`#sw-${trip.id}`);
  const tick = ()=>{
    const end = trip.inflightEnd || Date.now();
    label.textContent = formatHMS(end - trip.inflightStart);
    if(trip.inflightEnd && inflightInterval){
      clearInterval(inflightInterval); inflightInterval = null;
    }
  };
  tick();
  if(!trip.inflightEnd){
    if(inflightInterval) clearInterval(inflightInterval);
    inflightInterval = setInterval(tick, 1000);
  }
}

function openSheet(){
  backdrop.classList.add('show');
  sheet.classList.add('show');
  document.body.classList.add('modal-open');
}

function closeSheet(){
  sheet.classList.remove('show');
  backdrop.classList.remove('show');
  document.body.classList.remove('modal-open');
  stepStack = [];
}
  
btnBack.addEventListener('click', () => {
  if (stepStack.length <= 1) { closeSheet(); return; }
  stepStack.pop();
  const prev = stepStack[stepStack.length-1];
  renderView(prev.title, prev.html);
});

/* -------------------- Utilities -------------------- */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]); }
function randomUniqueTimes(n){ const s=new Set(); while(s.size<n) s.add(randInt(0,1439)); return [...s]; }
function minutesToTime(mins){
  mins = ((mins % (24*60)) + (24*60)) % (24*60);
  const h24 = Math.floor(mins/60), m = mins % 60;
  const h12 = ((h24 + 11) % 12) + 1;
  const ampm = h24 < 12 ? 'AM' : 'PM';
  return `${h12}:${m.toString().padStart(2,'0')} ${ampm}`;
}
function overnightFlag(depMins, arrMins){ const w=t=>t>=0&&t<360; return w(depMins%1440)||w(arrMins%1440); }

/* Airline codes (used on Review & Pay) */
const AIRLINE_CODES = {
  'American Airlines':'AA','JetBlue':'B6','Delta':'DL','United':'UA','Southwest':'WN','Spirit':'NK',
  'Emirates':'EK','Singapore':'SQ','Lufthansa':'LH','SWISS':'LX','Korean Air':'KE','KLM':'KL','Qatar Airways':'QR','Air France':'AF','Qantas':'QF','CEBU Pacific':'5J','British Airways':'BA','Condor':'DE','easyJet':'U2'
};

/* Airline logos in / (repo root). Adjust filenames if your paths differ */
const LOGO_MAP = {
  'JetBlue':'jb-icon.png',
  'American Airlines':'aa-icon.png',
  'Delta':'dl-icon.png',
  'United':'ua-icon.png',
  'Southwest':'wn-icon.png',
  'Spirit':'nk-icon.png',
  'Emirates':'ek-icon.png',
  'Singapore':'sq-icon.png',
  'Lufthansa':'lh-icon.png',
  'SWISS':'lx-icon.png',
  'Korean Air':'ke-icon.png',
  'KLM':'kl-icon.png',
  'Qatar Airways':'qr-icon.png',
  'Air France':'af-icon.png',
  'Qantas':'qf-icon.png',
  'CEBU Pacific':'5J-icon.png',
  'British Airways':'ba-icon.png',
  'Condor':'de-icon.png',
  'easyJet':'U2-icon.png'
};
const logoFor = carrier => LOGO_MAP[carrier] ? `./${LOGO_MAP[carrier]}` : '';

/* very small localStorage wrapper */
const getTrips = () => { try { return JSON.parse(localStorage.getItem('trips')||'[]'); } catch(e){ return []; } };
const setTrips = (arr) => localStorage.setItem('trips', JSON.stringify(arr));
const saveTrip = (trip) => { const arr=getTrips(); arr.unshift(trip); setTrips(arr); };

  /* ----- CBP form storage (single saved form) ----- */
const CBP_KEY = 'cbpForm';
const getCBPForm = () => { try { return JSON.parse(localStorage.getItem(CBP_KEY) || 'null'); } catch(e){ return null; } };
const setCBPForm = (obj) => localStorage.setItem(CBP_KEY, JSON.stringify(obj));
const clearCBPForm = () => localStorage.removeItem(CBP_KEY);

function stamp(ts){
  const d = new Date(ts);
  const fmt = { year:'2-digit', month:'2-digit', day:'2-digit', hour:'numeric', minute:'2-digit' };
  return d.toLocaleString(undefined, fmt).replace(',', ''); // "09/28/25 4:23 PM"
}
function airportByCode(c){ return AIRPORTS.find(a => a.code === c) || { code:c, name:c }; }

  function airportLabel(code){
  const a = airportByCode(code);                // {code, name} or fallback
  const plain = (a?.name || String(code))       // strip trailing "(XXX)" if present
    .replace(/\s*\([A-Z]{3}\)\s*$/, '');
  return `${plain} (${a.code || code})`;        // always a string
}

/* time parsing for comparisons ("10:02 PM" → minutes) */
function timeStrToMins(s){
  if(!s) return 0;
  const m=s.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i); if(!m) return 0;
  let h=+m[1]%12, min=+m[2]; const pm=/PM/i.test(m[3]); if(pm) h+=12; return h*60+min;
}

  function computeDurationText(obj){
  if (obj.durationText) return obj.durationText;
  const dep = timeStrToMins(obj.schedDepart || obj.depart);
  let arr   = timeStrToMins(obj.schedArrive || obj.arrive);
  if (obj.plusOne) arr += 1440;
  const dur = arr - dep;
  if (!isFinite(dur) || dur <= 0) return '';
  return `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`;
}

/* Country mapping for INTL check */
function countryOf(code){
  if (['RFD','PER','LCA','PHP','MLR','IZO'].includes(code)) return 'US';
  if (['HND','GRV','SAU'].includes(code)) return 'JP';
  return 'US';
}
function isIntl(a,b){ return countryOf(a) !== countryOf(b); }

/* For conditional UI */
function needsPassportOnPassengers(from, to){
  return countryOf(from)==='US' && countryOf(to)==='JP';
}
function shouldShowCBPOnArrived(trip){
  return countryOf(trip.from) === 'JP'
      && countryOf(trip.to)   === 'US'
      && !trip.cbpDone;
}
const CITY_LABEL = { RFD:'Rockford', IZO:'Izolirani', PER:'Perth', LCA:'Larnaca' };

/* -------------------- Aircraft rules -------------------- */
const AIRCRAFT_RULES = {
  'PER-RFD': {
    'American Airlines':['A320','B737'],
    'JetBlue':['A320'],
    'Spirit':['A320'],
    'Delta':['A320'],
    'United':['A320','B737'],
    'Southwest':['B737']
  },
  'IZO-RFD': {
    'American Airlines':['B737','A320','B777'],
    'JetBlue':['A320'],
    'Southwest':['B737'],
    'Delta':['A320']
  },
  'LCA-RFD': {
    'JetBlue':['A320'],
    'Delta':['A320','B737','B757','CRJ700'],
    'Southwest':['B737'],
    'American Airlines':['A320','B737'],
    'United':['A320','B737']
  },
  'PHP-RFD': {
    'JetBlue':['A320'],
    'Delta':['A320'],
    'United':['A320'],
    'Southwest':['B737'],
    'American Airlines':['A320']
  },
  'HND-RFD': {
    'Lufthansa':['A350','A380','B747'],
    'Delta':['A350','B757'],
    'Emirates':['A380','B777','A350'],
    'Singapore':['A350','B777'],
    'British Airways':['B777', 'A380', 'A350'],
    'American Airlines':['B777','B787'],
    'KLM':['B777'],
    'SWISS':['A330','B777'],
    'Korean Air':['A380'],
    'Qatar Airways':['B777','A350','A380'],
    'Air France':['B777']
  },
  'MLR-RFD': {
    'American Airlines':['CRJ700','E190'],
    'JetBlue':['A320'],
    'United':['CRJ700','E190']
  },
  'GRV-RFD': {
    'United': ['B787']
  },
  'IZO-PER': {
    'American Airlines': ['CRJ700', 'E190']
  },
  'MLR-PER': {
    'American Airlines': ['A320', 'B737'],
    'JetBlue': ['A320'],
    'Southwest': ['B737'],
    'Delta': ['A320'],
    'United': ['A320', 'B737']
  },
  'LCA-PER': {
    'American Airlines': ['A320', 'B737'],
    'Delta': ['A320', 'B757', 'B737'],
    'Spirit': ['A320'],
    'United': ['A320']
  },
  'PER-PHP': {
    'American Airlines': ['A320', 'B737'],
    'Delta': ['A320'],
    'United': ['A320'],
    'Spirit': ['A320'],
    'Southwest': ['B737']
  },
  'GRV-PER': {
    'Qantas': ['A350']
  },
  'IZO-MLR': {
    'American Airlines': ['A320', 'B737'],
    'United': ['A320'],
    'Delta': ['A320']
  },
  'LCA-MLR': {
    'Delta': ['A320', 'B737'],
    'United': ['A320'],
    'Spirit': ['A320'],
    'American Airlines': ['A320']
  },
  'MLR-PHP': {
    'American Airlines': ['A320'],
    'United': ['A320', 'B737'],
    'Delta': ['A320']
  },
  'IZO-LCA': {
    'American Airlines': ['A320', 'B737'],
    'Delta': ['A320'],
    'United': ['A320']
  },
  'IZO-PHP': {
    'American Airlines': ['A320', 'B737'],
    'Spirit': ['A320']
  },
  'HND-IZO': {
    'American Airlines': ['B777']
  },
  'GRV-IZO': {
    'Lufthansa': ['A350']
  },
  'LCA-PHP': {
    'Delta': ['CRJ700', 'E190']
  },
  'HND-LCA': {
    'Delta': ['A350'],
    'Singapore': ['A350'],
    'Emirates': ['A380']
  },
  'GRV-LCA': {
    'Delta': ['A350']
  },
  'GRV-HND': {
    'Lufthansa': ['A320'],
    'CEBU Pacific': ['A320'],
    'British Airways': ['A320'],
    'Qatar Airways': ['A320'],
    'Condor': ['A320'],
    'easyJet': ['A320']
  },
  'HND-SAU': {
    'SWISS': ['A320'],
    'Qatar Airways': ['A320'],
    'Lufthansa': ['A320'],
    'British Airways': ['A320'],
    'Condor': ['A320']
  },
  'GRV-SAU': {
    'SWISS': ['A320'],
    'easyJet': ['A320']
  }
};

function routeKey(a,b){ return [a,b].sort().join('-'); }
function pickAircraft(fromCode,toCode,carrier){
  const rules = AIRCRAFT_RULES[routeKey(fromCode,toCode)];
  if(!rules || !rules[carrier] || rules[carrier].length===0) return '';
  const list = rules[carrier];
  return list[randInt(0, list.length-1)];
}

/* -------------------- Route builders (NONSTOP ONLY) -------------------- */
function buildRfdPerResults(from,to){
  const carriers=['American Airlines','JetBlue',...shuffle(['United','Spirit','Southwest','Delta'])];
  const depTimes=randomUniqueTimes(6);
  const durations=Array.from({length:6},()=>randInt(120,180));
  const allPrices=Array.from({length:6},()=>randInt(250,600));
  const sorted=[...allPrices].sort((a,b)=>a-b), cheap1=sorted[0], cheap2=sorted[1];
  const rest=[...allPrices]; let i=rest.indexOf(cheap1); if(i>-1)rest.splice(i,1); i=rest.indexOf(cheap2); if(i>-1)rest.splice(i,1);
  const prices=[cheap1,cheap2,...rest];
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

function buildRfdIzoResults(from,to){
  const carriers=['American Airlines','American Airlines','JetBlue',...shuffle(['JetBlue','Southwest','Delta'])];
  const depTimes=randomUniqueTimes(6), durations=Array.from({length:6},()=>randInt(120,180)), prices=Array.from({length:6},()=>randInt(250,600));
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

function buildRfdLcaResults(from,to){
  const carriers=['JetBlue','Delta','Delta',...shuffle(['American Airlines','Southwest','United'])];
  const depTimes=randomUniqueTimes(6), durations=Array.from({length:6},()=>randInt(90,120)), prices=Array.from({length:6},()=>randInt(250,550));
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

function buildRfdPhpResults(from,to){
  const carriers=['JetBlue','JetBlue','Delta',...shuffle(['American Airlines','United','Southwest'])];
  const depTimes=randomUniqueTimes(6), durations=Array.from({length:6},()=>randInt(90,120)), prices=Array.from({length:6},()=>randInt(250,550));
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

/* RFD ↔ HND (Tokyo) */
function buildRfdHndResults(fromCode, toCode){
  const firstSix = shuffle(['American Airlines','Delta','Emirates','Singapore','British Airways','Lufthansa']);
  const pool = ['SWISS','Korean Air','KLM','Qatar Airways','Air France'];
  const lastSix = shuffle((() => { const out=[...pool]; while(out.length<6) out.push(pool[randInt(0,pool.length-1)]); return out; })());
  const carriers = [...firstSix, ...lastSix];

  const depTimes  = randomUniqueTimes(12);
  const durations = Array.from({length:12}, () => randInt(510, 720));  // 8.5–12h
  const prices    = Array.from({length:12}, () => randInt(900, 1100));

  const tzDelta =
    (countryOf(fromCode) === 'US' && countryOf(toCode) === 'JP') ? 360 :
    (countryOf(fromCode) === 'JP' && countryOf(toCode) === 'US') ? -360 : 0;

  return carriers.map((carrier, i) => {
    const depMins = depTimes[i];
    const dur     = durations[i];
    const arrMins = depMins + dur + tzDelta;
    return {
      from: fromCode, to: toCode,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(fromCode,toCode,carrier)
    };
  });
}

function buildRfdMlrResults(from,to){
  const carriers=['American Airlines','JetBlue','United',...shuffle(['American Airlines','United','JetBlue'])];
  const depTimes=randomUniqueTimes(6), durations=Array.from({length:6},()=>randInt(30,60)), prices=Array.from({length:6},()=>randInt(150,250));
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

/* RFD ↔ GRV (Grindavik) */
// RFD ↔ GRV: RFD departs 4:00 PM; GRV departs 8:30 AM
function buildRfdGrvResults(fromCode, toCode){
  const depMins = (fromCode === 'RFD') ? (16*60) : (8*60 + 30); // 4:00 PM or 8:30 AM
  const dur     = randInt(360, 480); // 6–8h
  const tzDelta =
    (countryOf(fromCode) === 'US' && countryOf(toCode) === 'JP') ? 360 :
    (countryOf(fromCode) === 'JP' && countryOf(toCode) === 'US') ? -360 : 0;

  const arrMins = depMins + dur + tzDelta;
  const price   = randInt(850, 1100);

  return [{
    from: fromCode, to: toCode,
    depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
    plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
    durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
    nonstop: true, price, carrier: 'United',
    overnight: overnightFlag(depMins, arrMins),
    aircraft: pickAircraft(fromCode, toCode, 'United')
  }];
}

function buildPerIzoResults(from, to){
  const carriers = Array(4).fill('American Airlines');
  const depTimes  = randomUniqueTimes(4);
  const durations = Array.from({length:4}, () => randInt(30, 60));
  const prices    = Array.from({length:4}, () => randInt(150, 250));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildPerMlrResults(from, to){
  const carriers = ['American Airlines', 'JetBlue', 'United','Southwest', 'Delta', 'United'];
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(120, 180));
  const prices    = Array.from({length:6}, () => randInt(250, 600));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildPerLcaResults(from, to){
  const carriers = ['American Airlines', 'Delta', 'Delta','Spirit', 'United', 'American Airlines'];
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(120, 180));
  const prices    = Array.from({length:6}, () => randInt(250, 550));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildPerPhpResults(from, to){
  const carriers = ['American Airlines', 'Delta', 'United','Spirit', 'Southwest'];
  const depTimes  = randomUniqueTimes(5);
  const durations = Array.from({length:5}, () => randInt(120, 180));
  const prices    = Array.from({length:5}, () => randInt(250, 550));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

// PER ↔ GRV: PER departs 5:00 AM; GRV departs 12:00 AM
function buildPerGrvResults(from, to){
  const carrier = 'Qantas';
  const depMins  = (from === 'PER') ? (5*60) : 0; // 5:00 AM or 12:00 AM
  const duration = randInt(480, 540);
  const tzDelta =
    (countryOf(from) === 'US' && countryOf(to) === 'JP') ? 360 :
    (countryOf(from) === 'JP' && countryOf(to) === 'US') ? -360 : 0;
  const arrMins = depMins + duration + tzDelta;
  const price   = randInt(950, 1200);

  return [{
    from, to,
    depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
    plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
    durationMin: duration,
    durationText: `${Math.floor(duration/60)}h ${String(duration%60).padStart(2,'0')}m`,
    nonstop: true, price, carrier,
    overnight: overnightFlag(depMins, arrMins),
    aircraft: pickAircraft(from, to, carrier)
  }];
}

function buildMlrIzoResults(from, to){
  const carriers = ['American Airlines', 'American Airlines', 'American Airlines','United', 'United', 'Delta'];
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(120, 180));
  const prices    = Array.from({length:6}, () => randInt(250, 600));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildMlrLcaResults(from, to){
  const carriers = ['Delta', 'Delta', 'United','Spirit', 'United', 'American Airlines'];
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(90, 120));
  const prices    = Array.from({length:6}, () => randInt(250, 550));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildMlrPhpResults(from, to){
  const carriers = ['American Airlines', 'United','Delta', 'United'];
  const depTimes  = randomUniqueTimes(4);
  const durations = Array.from({length:4}, () => randInt(90, 120));
  const prices    = Array.from({length:4}, () => randInt(250, 550));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildIzoLcaResults(from, to){
  const carriers = ['American Airlines', 'American Airlines', 'Delta','Delta', 'Delta', 'United'];
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(90, 120));
  const prices    = Array.from({length:6}, () => randInt(250, 550));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildIzoPhpResults(from, to){
  const carriers = ['American Airlines', 'American Airlines','Spirit', 'Spirit'];
  const depTimes  = randomUniqueTimes(4);
  const durations = Array.from({length:4}, () => randInt(90, 120));
  const prices    = Array.from({length:4}, () => randInt(250, 550));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildIzoHndResults(from, to){
  const carriers = ['American Airlines','American Airlines','American Airlines'];

  // HND → IZO should depart 1:20 PM, 3:20 PM, 6:40 PM
  // Keep the old late-evening schedule for the reverse direction.
  const fixedDepTimes = (from === 'HND' && to === 'IZO')
    ? [13*60 + 20, 15*60 + 20, 18*60 + 40]           // 1:20pm, 3:20pm, 6:40pm
    : [18*60 + 45, 20*60 + 20, 23*60 + 40];          // original: 6:45pm, 8:20pm, 11:40pm

  const durations = Array.from({length:3}, () => randInt(420, 510));
  const prices    = Array.from({length:3}, () => randInt(850, 1100));

  const tzDelta =
    (countryOf(from) === 'US' && countryOf(to) === 'JP') ? 360 :
    (countryOf(from) === 'JP' && countryOf(to) === 'US') ? -360 : 0;

  return carriers.map((carrier, i) => {
    const depMins = fixedDepTimes[i], dur = durations[i], arrMins = depMins + dur + tzDelta;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}
  
function buildIzoGrvResults(from, to){
  const carrier = 'Lufthansa';

  // GRV → IZO should depart 10:30 PM; IZO → GRV stays 6:40 PM
  // (times are minutes after midnight)
  const depMins = (from === 'GRV' && to === 'IZO')
    ? (13*60 + 20)   // 1:20 PM
    : (18*60 + 40);  // 6:40 PM

  const dur      = randInt(510, 600);
  const tzDelta =
    (countryOf(from) === 'US' && countryOf(to) === 'JP') ? 360 :
    (countryOf(from) === 'JP' && countryOf(to) === 'US') ? -360 : 0;
  const arrMins = depMins + dur + tzDelta;
  const price   = randInt(900, 1200);

  return [{
    from, to,
    depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
    plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
    durationMin: dur,
    durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
    nonstop: true, price, carrier,
    overnight: overnightFlag(depMins, arrMins),
    aircraft: pickAircraft(from, to, carrier)
  }];
}

function buildLcaPhpResults(from, to){
  const carriers = Array(6).fill('Delta');
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(30, 60));
  const prices    = Array.from({length:6}, () => randInt(100, 250));
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildLcaHndResults(from, to){
  const isLcaToHnd = (from === 'LCA' && to === 'HND');

  // Fixed departure times by direction + carrier
  const schedule = isLcaToHnd
    ? [
        { carrier: 'Emirates',  timeMins: 9*60 },        // 9:00 AM
        { carrier: 'Delta',     timeMins: 17*60 },       // 5:00 PM
        { carrier: 'Singapore', timeMins: 17*60 + 30 },  // 5:30 PM
      ]
    : [
        { carrier: 'Delta',     timeMins: 5*60 },        // 5:00 AM
        { carrier: 'Singapore', timeMins: 5*60 + 30 },   // 5:30 AM
        { carrier: 'Emirates',  timeMins: 22*60 },       // 10:00 PM
      ];

  // Duration: 13h–15h (in minutes)
  const durations = Array.from({length: schedule.length}, () => randInt(780, 900));
  const prices    = Array.from({length: schedule.length}, () => randInt(950, 1250));

  // Keep your existing JP/US tz delta rule
  const tzDelta =
    (countryOf(from) === 'US' && countryOf(to) === 'JP') ? 360 :
    (countryOf(from) === 'JP' && countryOf(to) === 'US') ? -360 : 0;

  return schedule.map((s, i) => {
    const depMins = s.timeMins;
    const dur     = durations[i];
    const arrMins = depMins + dur + tzDelta;

    return {
      from, to,
      depart: minutesToTime(depMins),
      arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true,
      price: prices[i],
      carrier: s.carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, s.carrier)
    };
  });
}

// LCA ↔ GRV: LCA departs 1:30 AM; GRV departs 6:00 PM
function buildLcaGrvResults(from, to){
  const carrier = 'Delta';
  const depMins = (from === 'LCA') ? (1*60 + 30) : (18*60); // 1:30 AM or 6:00 PM
  const dur      = randInt(360, 480);
  const tzDelta =
    (countryOf(from) === 'US' && countryOf(to) === 'JP') ? 360 :
    (countryOf(from) === 'JP' && countryOf(to) === 'US') ? -360 : 0;
  const arrMins  = depMins + dur + tzDelta;
  const price    = randInt(900, 1150);

  return [{
    from, to,
    depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
    plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
    durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
    nonstop: true, price, carrier,
    overnight: overnightFlag(depMins, arrMins),
    aircraft: pickAircraft(from, to, carrier)
  }];
}

function buildHndGrvResults(from, to){
  const carriers = ['Lufthansa', 'CEBU Pacific', 'British Airways','Qatar Airways', 'Condor', 'easyJet'];
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(120, 180));
  const prices    = Array.from({length:6}, () => randInt(250, 600));
  const tzDelta =
    (countryOf(from) === 'US' && countryOf(to) === 'JP') ? 360 :
    (countryOf(from) === 'JP' && countryOf(to) === 'US') ? -360 : 0;
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur + tzDelta;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildHndSauResults(from, to){
  const carriers = ['SWISS', 'Qatar Airways', 'Lufthansa','British Airways', 'Condor', 'SWISS'];
  const depTimes  = randomUniqueTimes(6);
  const durations = Array.from({length:6}, () => randInt(180, 240));
  const prices    = Array.from({length:6}, () => randInt(250, 650));
  let tzDelta = 0;
  if (from === 'HND' && to === 'SAU') tzDelta = 60;
  else if (from === 'SAU' && to === 'HND') tzDelta = -60;
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur + tzDelta;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildGrvSauResults(from, to){
  const carriers = ['SWISS','SWISS','easyJet','easyJet'];
  const depTimes  = randomUniqueTimes(4);
  const durations = Array.from({length:4}, () => randInt(90, 150));
  const prices    = Array.from({length:4}, () => randInt(250, 550));
  let tzDelta = 0;
  if (from === 'GRV' && to === 'SAU') tzDelta = 60;
  else if (from === 'SAU' && to === 'GRV') tzDelta = -60;
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur + tzDelta;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

function buildHndMlrResults(from, to){
  const carriers = ['Delta','American Airlines','United','Qatar Airways','Lufthansa'];
  const depTimes  = randomUniqueTimes(5);
  const durations = Array.from({length:5}, () => randInt(510, 720));
  const prices    = Array.from({length:5}, () => randInt(900, 1200));
  const tzDelta =
    (countryOf(from) === 'US' && countryOf(to) === 'JP') ? 360 :
    (countryOf(from) === 'JP' && countryOf(to) === 'US') ? -360 : 0;
  return carriers.map((carrier, i) => {
    const depMins = depTimes[i], dur = durations[i], arrMins = depMins + dur + tzDelta;
    return {
      from, to,
      depart: minutesToTime(depMins), arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur, durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true, price: prices[i], carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(from, to, carrier)
    };
  });
}

/* -------------------- Results list (nonstop) -------------------- */
function resultsView(list){
  const div = document.createElement('div');
  div.className = 'results';

  list.forEach(opt => {
    const logo = logoFor(opt.carrier);
    const logoHTML = logo
      ? `<img class="airlogo ${opt.carrier==='easyJet' ? 'is-u2' : ''}" src="${logo}" alt="${opt.carrier} logo">`
      : '';

    const card = document.createElement('div');
    card.className = 'card-result';
    card.innerHTML = `
      <div class="row-top">
        <div class="pair">
          <div class="code">${opt.from}</div>
          <div class="arrow">→</div>
          <div class="code">${opt.to}</div>
        </div>
        <div class="right-price">
          <span>$${opt.price.toLocaleString()}</span>
          <svg viewBox="0 0 24 24">
            <path d="M9 6l6 6-6 6" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>

      <div class="row-top" style="margin-top:6px">
        <div class="timepair">
          ${opt.depart} &nbsp;→&nbsp; ${opt.arrive}
          ${opt.plusOne ? `<span class="plus1">${opt.plusOne}</span>` : ''}
        </div>
      </div>

      <div class="row-mid">
        ${logoHTML}
        <div class="row-mid-text">
          <div>Nonstop &nbsp;•&nbsp; ${opt.durationText}</div>
          <div class="carrier-line">${opt.carrier}</div>
        </div>
      </div>

      <div class="row-foot ${opt.overnight ? '' : 'hide'}">
        <svg width="16" height="16" viewBox="0 0 24 24">
          <path d="M12 9v4m0 4h.01M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2z" stroke="#ffcc66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Overnight flight</span>
      </div>
    `;
    card.addEventListener('click', () => openSummary(opt));
    div.appendChild(card);
  });

  return div;
}

function renderView(title, node){
  routeTitle.textContent = title;
  sheetBody.innerHTML = '';
  sheetBody.appendChild(node);
}

/* -------------------- Steps -------------------- */
let lastSelection=null;

function openSummary(opt){
  lastSelection = {...opt, airlineCode: AIRLINE_CODES[opt.carrier] || ''};
  lastSelection.travelDate = document.getElementById('depart').value || '';

  const v = document.createElement('div');
  v.className = 'view';

  const warn = opt.overnight ? `
    <div class="panel" style="color:#ffcc66; display:flex; align-items:center; gap:8px">
      <svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 9v4m0 4h.01M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2z" stroke="#ffcc66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Overnight flight
    </div>` : '';

  v.innerHTML = `
    <div class="panel">
      <div style="font-weight:800; color:#21d07a; margin-bottom:6px">DEPART</div>
      <div style="font-size:17px; color:#e9eef4; margin-bottom:6px">${opt.from} to ${opt.to}</div>
      <div class="kv"><span><b>${opt.depart}</b> → <b>${opt.arrive}</b> ${opt.plusOne?'<span class="muted">+1</span>':''}</span><span>Nonstop</span></div>
      <div class="kv"><span>Duration</span><b>${opt.durationText}</b></div>
      <div class="kv"><span>Aircraft</span><b>${opt.aircraft || '—'}</b></div>
    </div>

    ${warn}

    <div class="panel"><div class="kv"><span>Total amount due</span><b>$${opt.price.toLocaleString()}</b></div></div>

    <!-- ATC24 tiny slider -->
    <div class="atc24-toggle">
      <label class="tiny-switch">
        <span>ATC24</span>
        <input id="atc24Chk" type="checkbox">
        <span class="tiny-track"><span class="tiny-knob"></span></span>
      </label>
    </div>

    <button class="btn-lg" id="goPassengers">Continue</button>
  `;

  // (this JS MUST be after innerHTML, not inside it)
  v.querySelector('#atc24Chk').addEventListener('change', (e)=>{
    lastSelection.atc24 = !!e.target.checked;
  });
  v.querySelector('#goPassengers').addEventListener('click', ()=>openPassengers());

  if(!stepStack.length) openSheet();
  stepStack = [{title:'Your trip summary', html:v}];
  renderView('Your trip summary', v);
}

/* -------- Passengers step (real form + branching) -------- */
function openPassengers(){
  const v = document.createElement('div'); 
  v.className = 'view';

  const isATC24 = !!(lastSelection && lastSelection.atc24);

  v.innerHTML = `
    ${isATC24 ? `<div class="atc24-banner">ATC24</div>` : ``}

    <div class="panel">
      <h3>Passenger details</h3>
      <div class="form-row">
        <div class="field">
          <label>First name •</label>
          <input id="pFirst" type="text" autocomplete="given-name" placeholder="e.g., Alex">
        </div>
        <div class="field">
          <label>Middle name</label>
          <input id="pMiddle" type="text" autocomplete="additional-name" placeholder="">
        </div>
        <div class="field">
          <label>Last name •</label>
          <input id="pLast" type="text" autocomplete="family-name" placeholder="e.g., Chen">
        </div>
      </div>

      <div class="form-row half">
        <div class="field">
          <label>Date of birth •</label>
          <input id="pDob" type="date">
        </div>
        <div class="field">
          <label>Passport #</label>
          <input id="pPass" type="text" inputmode="numeric" placeholder="">
        </div>
      </div>
    </div>

    <button class="btn-lg" id="btnPassengersNext" type="button">
      ${isATC24 ? 'Book flight' : 'Continue'}
    </button>
    <div class="muted" style="margin-top:8px">
      ${isATC24 
        ? 'ATC24: payment handled via account; booking finalizes now.'
        : 'You can review and pay on the next step.'}
    </div>
  `;

  v.querySelector('#btnPassengersNext').addEventListener('click', () => {
    const first = v.querySelector('#pFirst').value.trim();
    const middle = v.querySelector('#pMiddle').value.trim();
    const last  = v.querySelector('#pLast').value.trim();
    const dob   = v.querySelector('#pDob').value;
    const pass  = v.querySelector('#pPass').value.trim();

    if(!first || !last || !dob){
      alert('Please fill first name, last name, and date of birth.');
      return;
    }

    // persist passenger data for confirmation + tickets
    passengerData = { first, middle, last, dob, passport: pass };

    if (isATC24){
      // Skip review & pay → book immediately
      showProcessing();
      setTimeout(showConfirmation, 1200);
    } else {
      // Regular flow → go to Review & Pay
      openReviewPay();
    }
  });

  stepStack.push({ title:'Passenger details', html:v });
  renderView('Passenger details', v);
}

function openReviewPay(){
  const v = document.createElement('div'); 
  v.className = 'view';

  // build connection details if present
  let connHTML = '';
  if (Array.isArray(lastSelection.segments) && lastSelection.segments.length){
    connHTML = `<div class="hr"></div>` + lastSelection.segments.map(seg=>`
      <div class="kv" style="color:#cfd6dd">
        <span>${seg.from} → ${seg.to}</span>
        <b>${seg.depart} → ${seg.arrive} ${seg.plusOne?'<span class="muted">+1</span>':''}</b>
      </div>
      <div class="kv muted">
        <span>${seg.carrier}</span><b>${seg.aircraft || '—'}</b>
      </div>
    `).join('');
  }

  const showStops = Array.isArray(lastSelection.connections) ? '' : '<div class="kv"><span>Stops</span><b>Nonstop</b></div>';

  v.innerHTML = `
    <div class="panel">
      <div style="font-weight:800; margin-bottom:6px">Your trip</div>
      <div style="font-size:16px; margin-bottom:6px">${lastSelection.from} → ${lastSelection.to}</div>
      <div class="kv"><span><b>${lastSelection.depart}</b> → <b>${lastSelection.arrive}</b> ${lastSelection.plusOne?'<span class="muted">+1</span>':''}</span><span>${lastSelection.airlineCode||''}</span></div>
      <div class="kv"><span>Duration</span><b>${lastSelection.durationText}</b></div>
      ${showStops}
      <div class="kv"><span>Aircraft</span><b>${lastSelection.aircraft || '—'}</b></div>
      ${connHTML}
    </div>

    <div class="panel">
      <h3>Cost summary</h3>
      <div class="kv"><span>Economy</span><b>$${lastSelection.price.toLocaleString()}</b></div>
      <div class="kv" style="border-top:1px solid rgba(255,255,255,.1); padding-top:8px; margin-top:8px;">
        <span>Total amount due (All passengers)</span><b>$${lastSelection.price.toLocaleString()}</b>
      </div>
    </div>

    <div class="panel">
      <h3>Credit / debit card</h3>
      <div class="form-row">
        <div class="field"><label>Card number •</label><input id="ccNumber" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456"></div>
        <div class="form-row half">
          <div class="field"><label>Expiry date •</label><input id="ccExp" type="text" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY"></div>
          <div class="field"><label>Security code •</label><input id="ccCvv" type="text" inputmode="numeric" autocomplete="cc-csc" placeholder="CVV" maxlength="4"></div>
        </div>
        <div class="field"><label>Billing address •</label><input type="text" autocomplete="address-line1" placeholder="Street address"></div>
        <div class="form-row half">
          <div class="field"><label>Cardholder name •</label><input id="ccName" type="text" autocomplete="cc-name" placeholder="Full name"></div>
          <div class="field"><label>Postal code •</label><input type="text" autocomplete="postal-code" placeholder="ZIP / Postal"></div>
        </div>
      </div>
      <label class="agree"><input id="agreeCheckbox" type="checkbox"><span>I agree to the terms and conditions, refund policy, and conditions of carriage.</span></label>
      <button class="btn-lg" id="btnPay">Pay now</button>
      <div class="muted" style="display:flex; align-items:center; gap:6px; margin-top:8px">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.25 3.438 10.063 9 12 5.563-1.938 9-6.75 9-12V5l-9-4z" fill="none" stroke="#9aa3af" stroke-width="1.5"/></svg>
        Secure checkout
      </div>
    </div>
  `;

  /* <-- attach the handler AFTER setting innerHTML */
  v.querySelector('#btnPay').addEventListener('click', handlePay);

  stepStack.push({title:'Review and pay', html:v});
  renderView('Review and pay', v);
}

function handlePay(){
  const agree = document.getElementById('agreeCheckbox')?.checked;
  const ccNumber = (document.getElementById('ccNumber')?.value || '').replace(/\s+/g,'');
  const ccExp = (document.getElementById('ccExp')?.value || '').trim();
  const ccCvv = (document.getElementById('ccCvv')?.value || '').trim();
  const ccName = (document.getElementById('ccName')?.value || '').trim();

  if(!ccNumber || !ccExp || !ccCvv || !ccName){
    alert('Please complete card details.');
    return;
  }
  if(!agree){
    alert('Please agree to the terms.');
    return;
  }
  showProcessing();
  setTimeout(showConfirmation, 3000);
}

function showProcessing(){
  const v = document.createElement('div'); v.className='view';
  v.innerHTML = `
    <div class="glass processing">
      <div class="spinner" aria-hidden="true"></div>
      <div style="font-weight:800; font-size:18px">Processing transaction</div>
      <div class="muted">Booking… please wait</div>
    </div>
  `;
  stepStack.push({title:'Processing…', html:v});
  renderView('Processing…', v);
}

function showConfirmation(){
  const p = passengerData || {};
  const fullName = [p.first, p.middle, p.last].filter(Boolean).join(' ');
  const bookingRef = randDigits(6);
  const ticketNo  = randDigits(13);

  // Save to Trips
saveTrip({
  id: Date.now() + '-' + randDigits(4),
  status: 'CONFIRMED',            // CONFIRMED → INFLIGHT → ARRIVED → ARCHIVED
  atc24: !!lastSelection.atc24,
  carrier: lastSelection.carrier || '',
  logo: logoFor(lastSelection.carrier || ''),
  from: lastSelection.from,
  to: lastSelection.to,
  date: lastSelection.travelDate || '',           // ISO date from your form
  schedDepart: lastSelection.depart,
  schedArrive: lastSelection.arrive,
  plusOne: !!lastSelection.plusOne,
  aircraft: lastSelection.aircraft || '—',
  price: lastSelection.price || 0,
  passenger: fullName || 'Passenger 1',
  durationText: lastSelection.durationText || '',

  depGate: '', depTerminal: '',
  arrGate: '', arrTerminal: '',
  isArchived: false
});
renderTrips();    // refresh Trips page if it's open

  const v = document.createElement('div'); v.className='view';
  v.innerHTML = `
    <div class="glass" style="padding:18px 16px 14px;">
      <div class="check-wrap" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5" stroke-width="2" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="confirm-title" style="color:#63d488">Thank you for your purchase</div>
      <div class="confirm-sub">Your booking is confirmed</div>

      <div class="panel" style="margin-top:12px">
        <div class="kv"><span>Booking reference</span><b class="mono">${bookingRef}</b></div>
        <div class="kv"><span>e-Ticket number</span><b class="mono">${ticketNo}</b></div>
      </div>

      <div class="panel">
        <div class="kv"><span>Passenger</span><b>${fullName || 'Passenger 1'}</b></div>
        <div class="kv"><span>Route</span><b>${lastSelection.from} → ${lastSelection.to}</b></div>
        <div class="kv"><span>Date</span><b>${formatDate(lastSelection.travelDate)}</b></div>
        <div class="kv"><span>Times</span><b>${lastSelection.depart} → ${lastSelection.arrive} ${lastSelection.plusOne?'<span class="muted">+1</span>':''}</b></div>
        <div class="kv"><span>Carrier</span><b>${lastSelection.carrier || ''}</b></div>
        <div class="kv"><span>Amount paid</span><b>$${lastSelection.price.toLocaleString()}</b></div>
      </div>

      <div style="display:flex; gap:10px; margin-top:8px">
        <button class="btn-lg" style="flex:1" id="btnDone">Done</button>
      </div>
    </div>
  `;
  v.querySelector('#btnDone').addEventListener('click', () => { closeSheet(); });
  stepStack.push({title:'Booking confirmed', html:v});
  renderView('Booking confirmed', v);
}

/* -------------------- Search handler (nonstop routes only) -------------------- */
function needsVisa(from, to){
  return countryOf(from) === 'US' && countryOf(to) === 'JP';
}
  document.getElementById('btnSearch').addEventListener('click', () => {
  const from = fromSel.value, to = toSel.value;
const departDate = document.getElementById('depart').value;

if (!from || !to || !departDate) {
  const formCard = document.querySelector('.card');
  formCard.style.boxShadow = '0 0 0 4px rgba(255,80,80,.25)';
  setTimeout(()=>formCard.style.boxShadow = 'var(--shadow)', 350);
  return;
}

/* NEW — block US → JP when VISA not active and redirect to ID page */
if (needsVisa(from, to) && !isVisaActive()){
  openID();
  const w = document.getElementById('visaWarn');
  if (w){ w.classList.add('show'); setTimeout(()=>w.classList.remove('show'), 2500); }
  return;
}

  const key = [from, to].sort().join('-');

  let list;
  if (key==='PER-RFD') list=buildRfdPerResults(from,to);
  else if (key==='IZO-RFD') list=buildRfdIzoResults(from,to);
  else if (key==='LCA-RFD') list=buildRfdLcaResults(from,to);
  else if (key==='PHP-RFD') list=buildRfdPhpResults(from,to);
  else if (key==='HND-RFD') list=buildRfdHndResults(from,to);
  else if (key==='MLR-RFD') list=buildRfdMlrResults(from,to);
  else if (key==='GRV-RFD') list=buildRfdGrvResults(from,to);
  else if (key==='IZO-PER') list=buildPerIzoResults(from,to);
  else if (key==='MLR-PER') list=buildPerMlrResults(from,to);
  else if (key==='LCA-PER') list=buildPerLcaResults(from,to);
  else if (key==='PER-PHP') list=buildPerPhpResults(from,to);
  else if (key==='GRV-PER') list=buildPerGrvResults(from,to);
  else if (key==='IZO-MLR') list=buildMlrIzoResults(from,to);
  else if (key==='LCA-MLR') list=buildMlrLcaResults(from,to);
  else if (key==='MLR-PHP') list=buildMlrPhpResults(from,to);
  else if (key==='IZO-LCA') list=buildIzoLcaResults(from,to);
  else if (key==='IZO-PHP') list=buildIzoPhpResults(from,to);
  else if (key==='HND-IZO') list=buildIzoHndResults(from,to);
  else if (key==='GRV-IZO') list=buildIzoGrvResults(from,to);
  else if (key==='LCA-PHP') list=buildLcaPhpResults(from,to);
  else if (key==='HND-LCA') list=buildLcaHndResults(from,to);
  else if (key==='GRV-LCA') list=buildLcaGrvResults(from,to);
  else if (key==='GRV-HND') list=buildHndGrvResults(from,to);
  else if (key==='HND-SAU') list=buildHndSauResults(from,to);
  else if (key==='GRV-SAU') list=buildGrvSauResults(from,to);
  else if (key==='HND-MLR') list=buildHndMlrResults(from,to);
  else {
    const v=document.createElement('div'); v.className='view';
    v.innerHTML=`<div class="panel"><div class="kv"><span>Route</span><b>${from} → ${to}</b></div>
      <div class="muted">This prototype currently supports Rockford (RFD) ↔ Perth (PER), Rockford (RFD) ↔ Izolirani (IZO), Rockford (RFD) ↔ Larnaca (LCA), Rockford (RFD) ↔ Phaphos (PHP), and Rockford (RFD) ↔ Tokyo (HND).</div></div>`;
    openSheet(); renderView('Choose departure', v); stepStack=[{title:'Choose departure', html:v}];
    return;
  }

  const resNode = resultsView(list);
  openSheet(); renderView('Choose departure', resNode); stepStack=[{title:'Choose departure', html:resNode}];
});

  /* ---- Dock behavior ---- */
const dock = document.getElementById('dock');
const dockItems = dock.querySelectorAll('.dock-item');
const dockIndicator = dock.querySelector('.dock-indicator');
dock.style.setProperty('--tabs', dockItems.length);

function setActiveTab(idx){
  dockItems.forEach(b => {
    b.classList.remove('active');
    b.removeAttribute('aria-current');
  });
  dockItems[idx].classList.add('active');
  dockItems[idx].setAttribute('aria-current','page');
  dockIndicator.style.transform = `translateX(${idx*100}%)`;
}

// click to switch highlight
dockItems.forEach((btn, idx) => {
  btn.addEventListener('click', () => {
    setActiveTab(idx);
    // TODO: if you later add a Trips screen, navigate here.
    // e.g., openTrips();
  });
});

// default tab on load
setActiveTab(0);

  /* ---------- Simple screen switcher with a smooth fade ---------- */
function showScreen(id){
  const next = document.getElementById(id);
  const curr = document.querySelector('.screen.show');

  if (curr === next) return;

  // show next
  next.style.display = 'block';
  // force reflow so transition runs
  next.getBoundingClientRect();
  next.classList.add('show');

  // hide current after transition
  if (curr){
    curr.classList.remove('show');
    setTimeout(()=>{ if(!curr.classList.contains('show')) curr.style.display = 'none'; }, 300);
  }
}

const dockBookingBtn = document.querySelector('.dock .dock-item[data-tab="booking"]');
const dockTripsBtn   = document.querySelector('.dock .dock-item[data-tab="trips"]');
const dockStatsBtn   = document.querySelector('.dock .dock-item[data-tab="stats"]'); // if you added Stats
const dockIDBtn      = document.querySelector('.dock .dock-item[data-tab="id"]');

function openBooking(){ setActiveTab(0); showScreen('screen-booking'); }
function openTrips(){ setActiveTab(1); showScreen('screen-trips'); }
function openStats(){ setActiveTab(2); showScreen('screen-stats'); } // if you added Stats
function openID(){ setActiveTab(3); showScreen('screen-id'); renderIDPage(); } // (also defined above, either is fine)

dockBookingBtn?.addEventListener('click', openBooking);
dockTripsBtn?.addEventListener('click', openTrips);
dockStatsBtn?.addEventListener('click', openStats); // if present
dockIDBtn?.addEventListener('click', openID);
document.getElementById('btnCBPPage')?.addEventListener('click', openCBPPage);

// default
showScreen('screen-booking');

  /* ---------- Trips list ---------- */
function tripCardHTML(t, isArchived = false){
  const pillLabel = t.status === 'INFLIGHT' ? 'INFLIGHT'
                  : t.status === 'ARRIVED'  ? 'ARRIVED'
                  : 'ON TIME';

  const pillClass = t.status === 'INFLIGHT' ? 'pill-inflight'
                   : t.status === 'ARRIVED'  ? 'pill-arrived'
                   : 'pill-ontime';

  return `
    <div class="trip-card" data-id="${t.id}">
      <img class="trip-logo" alt="" src="${t.logo || ''}">
      <div class="trip-body">
        <div class="trip-times">
  ${
    t.atc24
    ? `<span class="chip-atc24">ATC24</span>`
    : `<b>${t.schedDepart}</b> &nbsp;→&nbsp; <b>${t.schedArrive}${t.plusOne ? ' <span class="muted">+1</span>' : ''}</b>`
  }
</div>
        <div class="trip-route">${t.from} &nbsp;→&nbsp; ${t.to}</div>
        <div class="trip-date">${formatDate(t.date)}</div>
      </div>

      <div class="trip-right">
        <span class="pill ${pillClass}">${pillLabel}</span>
        ${isArchived ? `<button class="mini-btn red btn-delete" type="button">Delete</button>` : ``}
      </div>
    </div>`;
}

function renderTrips(){
  const trips = getTrips();
const filtered = applyFilter(trips, currentTripsFilter);
const upcoming = filtered.filter(t => !t.isArchived);
const previous = filtered.filter(t => t.isArchived);

  const up = document.getElementById('upcomingList');
  const prev = document.getElementById('previousList');
  const empty = document.getElementById('upcomingEmpty');

  up.innerHTML = upcoming.map(t => tripCardHTML(t, false)).join('');
  prev.innerHTML = previous.map(t => tripCardHTML(t, true)).join('');

  empty.style.display = upcoming.length ? 'none' : '';
}

  /* ====== Stats helpers & renderer ====== */

// minutes between shown sched depart & sched arrive (respects +1 on schedule)
function tripScheduledMinutes(t){
  const dep = timeStrToMins(t.schedDepart || '');
  let arr   = timeStrToMins(t.schedArrive || '');
  if (t.plusOne) arr += 1440;
  const diff = arr - dep;
  return (isFinite(diff) && diff > 0) ? diff : 0;
}

// format totals: "Xd Yh" once >= 24h (no minutes); else "Xh YYm"
function formatTotalMinutes(mins){
  if (!mins || mins <= 0) return '0h 0m';
  const days = Math.floor(mins / 1440);
  if (days >= 1){
    const remH = Math.floor((mins - days*1440) / 60);
    return `${days}d ${remH}h`;
  }
  const hours = Math.floor(mins / 60);
  const m = mins % 60;
  return `${hours}h ${String(m).padStart(2,'0')}m`;
}

// sum of delays in minutes (only late minutes counted)
function totalDelayMinutes(trips){
  let sum = 0;
  trips.forEach(t=>{
    if (t.actualDepart && t.schedDepart){
      const d = timeStrToMins(t.actualDepart) - timeStrToMins(t.schedDepart);
      if (d > 0) sum += d;
    }
    if (t.actualArrive && t.schedArrive){
      const d = timeStrToMins(t.actualArrive) - timeStrToMins(t.schedArrive);
      if (d > 0) sum += d;
    }
  });
  return sum;
}

// most flown aircraft + a representative carrier logo for that aircraft
function mostFlownAircraft(trips){
  const byAc = {};
  trips.forEach(t=>{
    const ac = t.aircraft || '';
    if (!ac) return;
    byAc[ac] = (byAc[ac] || 0) + 1;
  });
  let topAc = '', topCount = 0;
  Object.entries(byAc).forEach(([k,c])=>{ if (c>topCount){ topAc=k; topCount=c; }});
  if (!topAc) return { aircraft:'—', logo:'', carrier:'' };

  const carrierCount = {};
  trips.filter(t=>t.aircraft===topAc).forEach(t=>{
    const c = t.carrier || '';
    if (!c) return;
    carrierCount[c] = (carrierCount[c] || 0) + 1;
  });
  const topCarrier = Object.keys(carrierCount).sort((a,b)=>carrierCount[b]-carrierCount[a])[0] || '';
  const logo = topCarrier ? logoFor(topCarrier) : '';

  return { aircraft: topAc, logo, carrier: topCarrier };
}

function renderStats(){
  const prev = applyFilter(getTrips(), currentStatsFilter).filter(t => t.isArchived);

  // Flight time (scheduled)
  const flightMins = prev.reduce((sum,t)=> sum + tripScheduledMinutes(t), 0);
  const ft = document.getElementById('statFlightTimeValue');
  if (ft) ft.textContent = formatTotalMinutes(flightMins);

  // IRL time (stopwatch)
  const irlMs = prev.reduce((sum,t)=> {
    const a = (typeof t.inflightStart==='number' && typeof t.inflightEnd==='number') ? (t.inflightEnd - t.inflightStart) : 0;
    return sum + Math.max(0, a);
  }, 0);
  const irlMins = Math.floor(irlMs / 60000);
  const irl = document.getElementById('statIrlTimeValue');
  if (irl) irl.textContent = formatTotalMinutes(irlMins);

  // Delays → hours (floor)
  const delayMins = totalDelayMinutes(prev);
  const delayHours = Math.floor(delayMins / 60);
  const dh = document.getElementById('statDelayHoursValue');
  if (dh) dh.textContent = `${delayHours}`;

  // Most flown aircraft
  const mf = mostFlownAircraft(prev);
  const ma = document.getElementById('statMostAircraft');
  const logo = document.getElementById('statMostAircraftLogo');
  if (ma)   ma.textContent = mf.aircraft || '—';
  if (logo){
    logo.src = mf.logo || '';
    logo.style.display = mf.logo ? 'block' : 'none';
  }
}

document.getElementById('upcomingList').addEventListener('click', e=>{
  const card = e.target.closest('.trip-card'); if(card) openTripDetail(card.dataset.id);
});
document.getElementById('previousList').addEventListener('click', e=>{
  const del = e.target.closest('.btn-delete');
  if (del){
    e.stopPropagation();
    const card = e.target.closest('.trip-card');
    if(card) confirmDelete(card.dataset.id);
    return;
  }
  const card = e.target.closest('.trip-card');
  if(card) openTripDetail(card.dataset.id);
});

  function airportTitle(code){
  const a = AIRPORTS.find(x=>x.code===code);
  // strip "(XXX)" from the end
  const n = (a?.name || code).replace(/\s*\([A-Z]{3}\)\s*$/,'');
  return `${code} • ${n}`;
}
function diffMins(a, b){ return timeStrToMins(a) - timeStrToMins(b); } // + = late, - = early

function openFilter(which){ // which: 'trips' | 'stats'
  const back = document.createElement('div'); back.className='flt-backdrop';
  const box  = document.createElement('div'); box.className='flt-modal';

  // current selection
  const initial = (which==='trips' ? currentTripsFilter : currentStatsFilter);

  box.innerHTML = `
    <h3>Show</h3>
    <div class="flt-options">
      <label class="flt-opt"><input type="radio" name="flt" value="all" ${initial==='all'?'checked':''}>All</label>
      <label class="flt-opt"><input type="radio" name="flt" value="regular" ${initial==='regular'?'checked':''}>Regular</label>
      <label class="flt-opt"><input type="radio" name="flt" value="atc24" ${initial==='atc24'?'checked':''}>ATC24</label>
    </div>
    <div class="flt-btns">
      <button class="flt-apply" id="fltApply" type="button">Filter</button>
    </div>
  `;

  function close(){
    back.classList.remove('show'); box.classList.remove('show');
    document.body.classList.remove('modal-open');
    setTimeout(()=>{ back.remove(); box.remove(); }, 220);
  }
  back.addEventListener('click', close);
  box.querySelector('#fltApply').addEventListener('click', ()=>{
    const sel = box.querySelector('input[name="flt"]:checked')?.value || 'all';
    if (which === 'trips'){ currentTripsFilter = sel; renderTrips(); }
    else                  { currentStatsFilter = sel; renderStats(); }
    close();
  });

  document.body.append(back, box);
  requestAnimationFrame(()=>{ back.classList.add('show'); box.classList.add('show'); document.body.classList.add('modal-open'); });
}

// wire the buttons (safe if missing)
document.getElementById('btnTripsFilter')?.addEventListener('click', ()=>openFilter('trips'));
document.getElementById('btnStatsFilter')?.addEventListener('click', ()=>openFilter('stats'));
  
  function openTripDetail(id){
  const trips = getTrips();
  const i = trips.findIndex(t => t.id === id);
  if (i < 0) return;
  const t = trips[i];

  // helpers local to this view
  function airportTitle(code){
    const a = AIRPORTS.find(x => x.code === code);
    const n = (a?.name || code).replace(/\s*\([A-Z]{3}\)\s*$/,'');
    return `${code} • ${n}`;
  }
  function diffMins(a, b){ return timeStrToMins(a) - timeStrToMins(b); } // + late, - early

  // which time to show (actual overrides scheduled)
  const depShown = t.actualDepart || t.schedDepart;
  const arrShown = t.actualArrive || t.schedArrive;

  // minute deltas when actuals exist
  const dDiff = t.actualDepart ? diffMins(t.actualDepart, t.schedDepart) : 0;
  const aDiff = t.actualArrive ? diffMins(t.actualArrive, t.schedArrive) : 0;

  // color classes for NEW times only
  const depClass = t.actualDepart ? (dDiff < 0 ? 'time-early' : dDiff > 0 ? 'time-late' : '') : '';
  const arrClass = t.actualArrive ? (aDiff < 0 ? 'time-early' : aDiff > 0 ? 'time-late' : '') : '';
  const durationText = computeDurationText(t);

  const v = document.createElement('div');
  v.className = 'view tdetail';

  v.innerHTML = `
  ${t.atc24 ? `<div class="atc24-banner">ATC24</div>` : `<div class="updated">Updated now</div>`}
  <div class="route">${t.from} &nbsp;→&nbsp; ${t.to}</div>
  ...

    <!-- Airline header -->
    <div class="tcard">
      <div class="trow">
        <img src="${t.logo || ''}" alt="" class="trip-logo" style="width:38px;height:38px;border-radius:10px;background:#13151a">
        <div>
          <div class="airline">${t.carrier || ''}</div>
          <div class="sub">${t.from} → ${t.to}</div>
          <div class="sub">${durationText ? `${durationText} • Nonstop` : ''}</div> <!-- NEW -->
        </div>
        <span class="pill ${t.status==='INFLIGHT'?'pill-inflight':t.status==='ARRIVED'?'pill-arrived':'pill-ontime'}">
          ${t.status==='INFLIGHT'?'INFLIGHT':t.status==='ARRIVED'?'ARRIVED':'ON TIME'}
        </span>
      </div>
      <!-- Stopwatch slot -->
      <div id="timerSlot" style="display:flex;justify-content:flex-end;margin-top:6px"></div>
    </div>

    <!-- Depart -->
    <div class="tcard section">
      <div class="headrow" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div class="airport">⦿ ${airportTitle(t.from)}</div>
        ${
          (t.depGate || t.depTerminal)
          ? `<div class="gatebox">
               ${t.depGate ? `<span class="gatepill">${t.depGate}</span>` : ``}
               ${t.depTerminal ? `<div class="term">${/^terminal/i.test(t.depTerminal) ? t.depTerminal : 'Terminal ' + t.depTerminal}</div>` : ``}
             </div>`
          : ``
        }
      </div>

      <div class="bigtime">
  ${
    t.atc24
      ? `<span class="chip-atc24 big">ATC24</span>`
      : `<span class="${depClass}">${depShown}</span>${t.actualDepart ? `<span class="sched-old">${t.schedDepart}</span>` : ''}`
  }
</div>

      ${
        t.actualDepart
          ? `<div class="delta ${dDiff>0?'late':dDiff<0?'early':''}">
               ${dDiff===0 ? 'On Time' : `${Math.abs(dDiff)}m ${dDiff>0?'Late':'Early'}`}
             </div>`
          : ''
      }

      <div class="sub" style="margin-top:10px">${t.durationText ? `${t.durationText} • Nonstop` : ''}</div>
    </div>

    <!-- Arrive -->
    <div class="tcard section">
      <div class="headrow" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div class="airport">⦿ ${airportTitle(t.to)}</div>
        ${
          (t.arrGate || t.arrTerminal)
          ? `<div class="gatebox">
               ${t.arrGate ? `<span class="gatepill">${t.arrGate}</span>` : ``}
               ${t.arrTerminal ? `<div class="term">${/^terminal/i.test(t.arrTerminal) ? t.arrTerminal : 'Terminal ' + t.arrTerminal}</div>` : ``}
             </div>`
          : ``
        }
      </div>

      <div class="bigtime">
  ${
    t.atc24
      ? `<span class="chip-atc24 big">ATC24</span>`
      : `<span class="${arrClass}">${arrShown}${t.plusOne ? ' <sup class="muted">+1</sup>' : ''}</span>${t.actualArrive ? `<span class="sched-old">${t.schedArrive}${t.plusOne ? ' +1':''}</span>` : ''}`
  }
</div>

      ${
        t.actualArrive
          ? `<div class="delta ${aDiff>0?'late':aDiff<0?'early':''}">
               ${aDiff===0 ? 'On Time' : `${Math.abs(aDiff)}m ${aDiff>0?'Late':'Early'}`}
             </div>`
          : ''
      }

      <div class="tfooter">
        <div class="kv"><span>Aircraft</span><b>${t.aircraft || '—'}</b></div>
        <div class="kv"><span>Passenger</span><b>${t.passenger || 'Passenger 1'}</b></div>
      </div>
    </div>

    <div style="height:6px"></div>
    <button class="btn-lg" id="btnStatus">Status</button>
  `;

  // render stopwatch (if any)
  renderInflightTimer(v.querySelector('#timerSlot'), t);

  v.querySelector('#btnStatus').addEventListener('click', () => openStatusActions(t));

  openSheet();
  renderView(`${t.from} → ${t.to}`, v);
  stepStack = [{ title: `${t.from} → ${t.to}`, html: v }];
}

/* ---------- Status Action Sheet ---------- */
/* ---------- Status Action Sheet ---------- */
function openStatusActions(trip){
  const back = document.createElement('div'); back.className='actions-backdrop';
  const box  = document.createElement('div'); box.className='actions';

  function close(){
    back.classList.remove('show'); box.classList.remove('show');
    document.body.classList.remove('modal-open');
    setTimeout(()=>{ back.remove(); box.remove(); }, 200);
  }
  back.addEventListener('click', close);

  document.body.append(back, box);
  requestAnimationFrame(()=>{ 
    back.classList.add('show'); 
    box.classList.add('show'); 
    document.body.classList.add('modal-open'); 
  });

  const st = trip.status;
  let html = '';

  if(st==='CONFIRMED'){
    html += `
      <div class="row"><button class="btn" id="toInflight">Change to INFLIGHT</button></div>
      ${trip.atc24 ? '' : `
        <div class="row" id="depRow" style="display:none">
          <div class="muted">Enter actual departure time</div>
          <input id="depTime" type="time">
          <button class="btn" id="upd1">Update status</button>
        </div>
      `}
    `;
  } else if(st==='INFLIGHT'){
    html += `
      <div class="row"><button class="btn" id="toArrived">Change status to ARRIVED</button></div>
      ${trip.atc24 ? '' : `
        <div class="row" id="arrRow" style="display:none">
          <div class="muted">Enter actual arrival time</div>
          <input id="arrTime" type="time">
          <button class="btn" id="upd2">Update status</button>
        </div>
      `}
    `;
  } else if(st==='ARRIVED'){
    html += `<div class="row"><button class="btn red" id="archive">Archive flight</button></div>`;
  }

  // Gate change UI (always available)
  html += `
    <div class="row"><button class="btn" id="chgGate">Change gate</button></div>
    <div class="row" id="gateMode" style="display:none">
      <div style="display:flex; gap:8px">
        <button class="btn" id="gateDep">Departure</button>
        <button class="btn" id="gateArr">Arrival</button>
      </div>
      <div id="gateForm" style="display:none">
        <input id="gateInput" type="text" placeholder="Gate (e.g., D12)">
        <input id="termInput" type="text" placeholder="Terminal (e.g., Main)">
        <button class="btn" id="saveGate">Save</button>
      </div>
    </div>
  `;
  box.innerHTML = html;

  // ---- Status handlers
  if(st==='CONFIRMED'){
    box.querySelector('#toInflight').addEventListener('click', ()=>{
      if (trip.atc24){
        const trips=getTrips(); const i=trips.findIndex(t=>t.id===trip.id);
        if(i>-1){
          trips[i].status='INFLIGHT';
          if (!trips[i].inflightStart) trips[i].inflightStart = Date.now();
          setTrips(trips);
        }
        close(); openTripDetail(trip.id); renderTrips();
      } else {
        box.querySelector('#depRow').style.display='grid';
      }
    });
    if (!trip.atc24){
      box.querySelector('#upd1').addEventListener('click', ()=>{
        const v = box.querySelector('#depTime').value; if(!v) return;
        const [H,M] = v.split(':').map(Number);
        const ampm  = H>=12?'PM':'AM'; const h12=((H+11)%12)+1; const disp=`${h12}:${String(M).padStart(2,'0')} ${ampm}`;
        const trips=getTrips(); const i=trips.findIndex(t=>t.id===trip.id);
        if(i>-1){
          trips[i].status='INFLIGHT'; trips[i].actualDepart=disp;
          if (!trips[i].inflightStart) trips[i].inflightStart = Date.now();
          setTrips(trips);
        }
        close(); openTripDetail(trip.id); renderTrips();
      });
    }
  } else if(st==='INFLIGHT'){
    box.querySelector('#toArrived').addEventListener('click', ()=>{
      if (trip.atc24){
        const trips=getTrips(); const i=trips.findIndex(t=>t.id===trip.id);
        if(i>-1){
          trips[i].status='ARRIVED';
          trips[i].inflightEnd = Date.now();
          setTrips(trips);
          const updated = trips[i];
          close(); openTripDetail(trip.id); renderTrips();
          requestAnimationFrame(()=>{ if (shouldShowCBPOnArrived?.(updated)) openCBPForm(updated); });
        }
      } else {
        box.querySelector('#arrRow').style.display='grid';
      }
    });
    if (!trip.atc24){
      box.querySelector('#upd2').addEventListener('click', ()=>{
        const v = box.querySelector('#arrTime').value; if(!v) return;
        const [H,M] = v.split(':').map(Number);
        const ampm  = H>=12?'PM':'AM'; const h12=((H+11)%12)+1; const disp=`${h12}:${String(M).padStart(2,'0')} ${ampm}`;
        const trips=getTrips(); const i=trips.findIndex(t=>t.id===trip.id);
        if(i>-1){
          trips[i].status='ARRIVED'; trips[i].actualArrive=disp;
          trips[i].inflightEnd = Date.now();
          setTrips(trips);
          const updated = trips[i];
        }
        close(); openTripDetail(trip.id); renderTrips();
        requestAnimationFrame(()=>{ if (shouldShowCBPOnArrived?.(trip)) openCBPForm(trip); });
      });
    }
  } else if(st==='ARRIVED'){
    box.querySelector('#archive').addEventListener('click', ()=>{
      const trips=getTrips(); const i=trips.findIndex(t=>t.id===trip.id);
      if(i>-1){
        trips[i].status='ARRIVED';
        trips[i].isArchived=true;
        setTrips(trips);
      }
      close(); closeSheet(); renderTrips(); renderStats();
    });
  }

  // ---- Gate handlers
  const gateMode = box.querySelector('#gateMode');
  const gateForm = box.querySelector('#gateForm');
  box.querySelector('#chgGate').addEventListener('click', ()=>{ gateMode.style.display='grid'; });
  let gateKind = '';
  box.querySelector('#gateDep').addEventListener('click', ()=>{ gateKind='dep'; gateForm.style.display='grid'; });
  box.querySelector('#gateArr').addEventListener('click', ()=>{ gateKind='arr'; gateForm.style.display='grid'; });
  box.querySelector('#saveGate').addEventListener('click', ()=>{
    const gate = box.querySelector('#gateInput').value.trim();
    const term = box.querySelector('#termInput').value.trim();
    if(!gate && !term) return;
    const trips=getTrips(); const i=trips.findIndex(t=>t.id===trip.id);
    if(i>-1){
      if(gateKind==='dep'){ trips[i].depGate = gate; trips[i].depTerminal = term; }
      else                { trips[i].arrGate = gate; trips[i].arrTerminal = term; }
      setTrips(trips);
    }
    close(); openTripDetail(trip.id); renderTrips();
  });
}
/* ===== ID / VISA state + UI ===== */
const VISA_KEY = 'visa';
let visaTimerHandle = null;

function getVisa(){
  try { return JSON.parse(localStorage.getItem(VISA_KEY) || '{"status":"EXPIRED"}'); }
  catch(e){ return { status:'EXPIRED' }; }
}
function setVisa(v){ localStorage.setItem(VISA_KEY, JSON.stringify(v)); }
function ensureVisaFresh(){
  const v = getVisa();
  if (v.status === 'ACTIVE' && v.expiresAt && Date.now() >= v.expiresAt){
    v.status = 'EXPIRED';
    delete v.expiresAt;
    setVisa(v);
  }
  return v;
}
function isVisaActive(){
  const v = ensureVisaFresh();
  return v.status === 'ACTIVE' && v.expiresAt && v.expiresAt > Date.now();
}
function rand13(){ let s=''; for(let i=0;i<13;i++) s += Math.floor(Math.random()*10); return s; }

function formatRemaining(ms){
  if (ms <= 0) return 'Expired';
  const sec = Math.floor(ms/1000);
  const d   = Math.floor(sec / 86400);
  const h   = Math.floor((sec % 86400) / 3600);
  const m   = Math.floor((sec % 3600) / 60);
  const s   = sec % 60;

  if (d > 0) return `${d}d ${h}h`;
  if (h > 0) return `${h}h ${String(m).padStart(2,'0')}m`;
  if (m > 0) return `${m}m ${String(s).padStart(2,'0')}s`;
  return `${s}s`;
}

function startVisaTimer(expiresAt){
  // clear previous
  if (visaTimerHandle) { clearInterval(visaTimerHandle); visaTimerHandle = null; }
  const el = document.getElementById('visaTimer');
  if (!el || !expiresAt) return;

  const tick = ()=>{
    const left = expiresAt - Date.now();
    el.textContent = formatRemaining(left);
    if (left <= 0){
      clearInterval(visaTimerHandle); visaTimerHandle = null;
      // flip to EXPIRED and re-render
      const v = getVisa();
      v.status = 'EXPIRED';
      delete v.expiresAt;
      setVisa(v);
      renderIDPage();
    }
  };
  tick();
  visaTimerHandle = setInterval(tick, 1000);
}

function renderIDPage(){
  const mount = document.getElementById('visaCardMount');
  if (!mount) return;
  const v = ensureVisaFresh();

  const isActive = v.status === 'ACTIVE' && v.expiresAt && v.expiresAt > Date.now();
  const statusClass = isActive ? 'active' : 'expired';
  const statusText  = isActive ? 'ACTIVE' : 'EXPIRED';
  const timerHTML   = isActive ? `<div class="visa-timer" id="visaTimer"></div>` : '';

  mount.innerHTML = `
    <div class="id-card visa" id="visaCard" role="button" tabindex="0" aria-label="Visa details">
      ${timerHTML}
      <div class="title"><em>VISA</em></div>
      <div class="row">
        <div class="label">Country</div>
        <div class="value">Japan (2-day)</div>
      </div>
      <span class="visa-status ${statusClass}">${statusText}</span>
    </div>
  `;

  // click opens modal
  const card = document.getElementById('visaCard');
  if (card){
    card.addEventListener('click', openVisaPopup);
    card.addEventListener('keypress', e=>{ if(e.key==='Enter' || e.key===' ') openVisaPopup(); });
  }

  // (re)start timer if active
  if (isActive) startVisaTimer(v.expiresAt);
}

  function openCBPPage(){
  // keep ID tab visually active; CBP is a subpage
  setActiveTab(3);
  showScreen('screen-cbp');
  renderCBPPage();
}

function renderCBPPage(){
  const mount = document.getElementById('cbpContent');
  const saved = getCBPForm();

  if(!saved){
    mount.innerHTML = `
      <div class="cbp-empty">No saved forms</div>
      <button class="cbp-bigbtn" id="btnNewCBP" type="button">New Submission</button>
    `;
    document.getElementById('btnNewCBP').addEventListener('click', openCBPWizard);
    return;
  }

  const apLabel = airportLabel(saved.port);
  mount.innerHTML = `
    <section class="id-card grad-ice">
      <div class="title">Saved form</div>
      <div class="kv"><span>CBP Port</span><b>${apLabel}</b></div>
      <div class="kv"><span>Traveler</span><b>${saved.name}</b></div>
      <div class="kv"><span>Saved</span><b>${stamp(saved.createdAt)}</b></div>
    </section>

    <div class="id-card" style="background:transparent; border-color:rgba(255,255,255,.12)">
      <div class="cbp-question">Have you arrived at ${apLabel}?</div>
      <div style="display:grid;gap:10px;margin-top:12px">
        <button class="btn-lg" id="cbpGoSubmit" type="button">Submit Form</button>
        <button class="mini-btn red" id="cbpDelete" type="button">Delete form</button>
      </div>
    </div>
  `;
  document.getElementById('cbpGoSubmit').addEventListener('click', ()=>{ openTrips(); });
  document.getElementById('cbpDelete').addEventListener('click', confirmDeleteCBP);
}

function confirmDeleteCBP(){
  const back = document.createElement('div'); back.className='confirm-backdrop';
  const box  = document.createElement('div'); box.className='confirm';
  box.innerHTML = `
    <h3>Delete saved CBP form?</h3>
    <p>This will remove it from this device.</p>
    <div class="row-btns">
      <button class="btn-outline" id="cCancel">Cancel</button>
      <button class="btn-danger" id="cDel">Delete</button>
    </div>
  `;
  function close(){
    back.classList.remove('show'); box.classList.remove('show');
    document.body.classList.remove('modal-open');
    setTimeout(()=>{ back.remove(); box.remove(); }, 220);
  }
  back.addEventListener('click', close);
  box.querySelector('#cCancel').addEventListener('click', close);
  box.querySelector('#cDel').addEventListener('click', ()=>{ clearCBPForm(); close(); renderCBPPage(); });

  document.body.append(back, box);
  requestAnimationFrame(()=>{ back.classList.add('show'); box.classList.add('show'); document.body.classList.add('modal-open'); });
}

  function openCBPWizard(){
  const back = document.createElement('div'); back.className='idv-backdrop';
  const box  = document.createElement('div'); box.className='idv-modal';
  document.body.append(back, box);
  requestAnimationFrame(()=>{ back.classList.add('show'); box.classList.add('show'); document.body.classList.add('modal-open'); });

  // US airports except MLR and PHP (based on your countryOf() mapping)
  const US_PORTS = AIRPORTS.filter(a => countryOf(a.code) === 'US' && !['MLR','PHP'].includes(a.code));

  const data = { port:'', name:'', q1:false, q2:false, q3:false };
  let step = 0;

  function close(){
    back.classList.remove('show'); box.classList.remove('show'); document.body.classList.remove('modal-open');
    setTimeout(()=>{ back.remove(); box.remove(); }, 220);
  }

  function view(){
    if(step===0){
      box.innerHTML = `
        <h3>CBP Port</h3>
        <div class="sub">Choose your U.S. arrival airport</div>
        <div class="idv-row">
          <div class="field">
            <label>Port of Entry</label>
            <select id="wPort">
              <option value="" disabled selected>Select</option>
              ${US_PORTS.map(a=>`<option value="${a.code}">${a.name}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="idv-btns">
          <button class="idv-btn" id="wCancel">Cancel</button>
          <button class="idv-btn primary" id="wNext">Next</button>
        </div>
      `;
    } else if(step===1){
      box.innerHTML = `
        <h3>Traveler full name</h3>
        <div class="idv-row">
          <div class="field"><label>Full name</label><input id="wName" type="text" placeholder="As on passport"></div>
        </div>
        <div class="idv-btns">
          <button class="idv-btn" id="wBack">Back</button>
          <button class="idv-btn primary" id="wNext">Next</button>
        </div>
      `;
    } else if(step===2){
      box.innerHTML = `
        <h3>Declarations</h3>
        <div class="idv-row">
          ${[
            {k:'q1', t:'Do I (we) have any commercial merchandise?'},
            {k:'q2', t:'Am I (we) transporting currency or monetary instruments equal to or greater than $10,000 U.S., or foreign equivalent, in any form?'},
            {k:'q3', t:'Do I (we) have any articles to declare that were acquired abroad and are being brought into the United States in excess of the duty free exemption?'},
          ].map(q=>`
            <div class="field">
              <label>${q.t}</label>
              <select id="${q.k}">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
          `).join('')}
        </div>
        <div class="idv-btns">
          <button class="idv-btn" id="wBack">Back</button>
          <button class="idv-btn primary" id="wSave">Save Form</button>
        </div>
      `;
    }

    // handlers for the current step
    box.querySelector('#wCancel')?.addEventListener('click', close);
    box.querySelector('#wNext')?.addEventListener('click', ()=>{
      if(step===0){
        const v = box.querySelector('#wPort').value; if(!v) return; data.port = v; step = 1; view();
      } else if(step===1){
        const v = (box.querySelector('#wName').value || '').trim(); if(!v) return; data.name = v; step = 2; view();
      }
    });
    box.querySelector('#wBack')?.addEventListener('click', ()=>{ step = Math.max(0, step-1); view(); });
    box.querySelector('#wSave')?.addEventListener('click', ()=>{
      data.q1 = box.querySelector('#q1').value === 'yes';
      data.q2 = box.querySelector('#q2').value === 'yes';
      data.q3 = box.querySelector('#q3').value === 'yes';
      setCBPForm({ ...data, createdAt: Date.now() });
      close();
      renderCBPPage();
    });
  }
  view();
}

function closeVisaModal(back, box){
  back.classList.remove('show'); box.classList.remove('show');
  document.body.classList.remove('modal-open');
  setTimeout(()=>{ back.remove(); box.remove(); }, 220);
}

function openVisaPopup(){
  const v = ensureVisaFresh();
  const back = document.createElement('div'); back.className = 'idv-backdrop';
  const box  = document.createElement('div'); box.className  = 'idv-modal';

  function mount(html){ box.innerHTML = html; }

  // active → show number + label
  if (v.status === 'ACTIVE' && v.expiresAt && v.expiresAt > Date.now()){
    const num = v.number || rand13();
    v.number = num; setVisa(v);

    mount(`
      <h3>VISA ${num}</h3>
      <div class="sub">Japan 2 day VISA</div>
      <div class="idv-btns">
        <button class="idv-btn" id="visaClose">Close</button>
      </div>
    `);
  } else {
    // expired → show renew button
    mount(`
      <h3>VISA</h3>
      <div class="sub">Your VISA has expired.</div>
      <div class="idv-btns">
        <button class="idv-btn" id="visaClose">Close</button>
        <button class="idv-btn primary" id="visaRenew">Renew VISA</button>
      </div>
    `);
  }

  back.addEventListener('click', ()=>closeVisaModal(back, box));
  document.body.append(back, box);
  requestAnimationFrame(()=>{ back.classList.add('show'); box.classList.add('show'); document.body.classList.add('modal-open'); });

  // wire buttons
  box.querySelector('#visaClose')?.addEventListener('click', ()=>closeVisaModal(back, box));
  box.querySelector('#visaRenew')?.addEventListener('click', ()=>{
    // show payment form
    box.innerHTML = `
      <h3>Japan 2 day VISA</h3>
      <div class="sub"><b>$14.99</b></div>
      <div class="idv-row">
        <div class="field"><label>Card number</label><input id="vccNumber" type="text" inputmode="numeric" placeholder="1234 5678 9012 3456"></div>
        <div class="idv-row" style="grid-template-columns:1fr 1fr; gap:8px">
          <div class="field"><label>Expiry (MM/YY)</label><input id="vccExp" type="text" inputmode="numeric" placeholder="MM/YY"></div>
          <div class="field"><label>CVV</label><input id="vccCvv" type="text" inputmode="numeric" placeholder="CVV" maxlength="4"></div>
        </div>
        <div class="field"><label>Cardholder name</label><input id="vccName" type="text" placeholder="Full name"></div>
        <label class="agree"><input id="vAgree" type="checkbox"><span>I agree to the terms.</span></label>
        <div class="idv-btns">
          <button class="idv-btn" id="visaCancel">Cancel</button>
          <button class="idv-btn primary" id="visaPay">Pay now</button>
        </div>
      </div>
    `;
    box.querySelector('#visaCancel').addEventListener('click', ()=>closeVisaModal(back, box));
    box.querySelector('#visaPay').addEventListener('click', ()=>{
      const cc = (document.getElementById('vccNumber')?.value||'').trim();
      const ex = (document.getElementById('vccExp')?.value||'').trim();
      const cv = (document.getElementById('vccCvv')?.value||'').trim();
      const nm = (document.getElementById('vccName')?.value||'').trim();
      const ok = document.getElementById('vAgree')?.checked;
      if (!cc || !ex || !cv || !nm || !ok){ alert('Please complete payment details and agree.'); return; }

      // loading
      box.innerHTML = `
        <div class="processing" style="padding:30px 8px">
          <div class="spinner" aria-hidden="true"></div>
          <div style="font-weight:800; font-size:18px">Processing transaction</div>
        </div>
      `;
      setTimeout(()=>{
        const now = Date.now();
        const v = { status:'ACTIVE', number: rand13(), expiresAt: now + 48*60*60*1000 };
        setVisa(v);
        renderIDPage();            // update card
        startVisaTimer(v.expiresAt);
        closeVisaModal(back, box); // close
      }, 4000);
    });
  });
}

/* screen switcher for ID */
function openID(){
  // close any open result sheet first
  try { closeSheet(); } catch(e){}
  setActiveTab(3);            // 0=Booking,1=Trips,2=Stats,3=ID
  showScreen('screen-id');
  renderIDPage();
}

/* helper: need VISA only US -> JP */
function needsVisa(from, to){
  return countryOf(from) === 'US' && countryOf(to) === 'JP';
}
/* render Trips on load */
renderTrips();
renderStats();

  function openCBPForm(trip){
  const back = document.createElement('div'); back.className='cbp-backdrop';
  const box  = document.createElement('div'); box.className='cbp-modal';

  const city = CITY_LABEL[trip.to] || trip.to;
  const savedForm = getCBPForm();
  const savedBlock = savedForm
    ? `<div class="cbp-saved" id="cbpSavedSel">Saved form ${stamp(savedForm.createdAt)}</div>`
    : '';

  box.innerHTML = `
  <div class="cbp-head">
    <img src="./cbp-icon.png" alt="CBP">
    <div class="cbp-hr"></div>
  </div>
  <div class="cbp-body">
    <div class="cbp-title">Arrival into ${city}</div>

    ${savedBlock}

    <div class="cbp-row">
      <label>Passport Number</label>
      <input id="cbpPassport" type="text" placeholder="XXXXXXXXX">
    </div>

    <div class="cbp-row">
      <label>Departure airport</label>
      <select id="cbpDeparture">
        <option value="" disabled selected>Select</option>
        <option value="HND">Tokyo Haneda (HND)</option>
        <option value="GRV">Grindavik (GRV)</option>
      </select>
    </div>

    <button class="btn-lg" id="cbpSubmit" type="button">Submit Form</button>
  </div>
`;

    const savedBox = box.querySelector('#cbpSavedSel');
savedBox?.addEventListener('click', ()=> savedBox.classList.toggle('selected'));

  function close(){
    back.classList.remove('show'); box.classList.remove('show');
    document.body.classList.remove('modal-open');
    setTimeout(()=>{ back.remove(); box.remove(); }, 220);
  }

  back.addEventListener('click', close);
  document.body.append(back, box);
  requestAnimationFrame(()=>{ back.classList.add('show'); box.classList.add('show'); document.body.classList.add('modal-open'); });

  box.querySelector('#cbpSubmit').addEventListener('click', ()=>{
  const passport = (box.querySelector('#cbpPassport').value || '').trim();
  const dep      = box.querySelector('#cbpDeparture').value || '';
  const useSaved = !!box.querySelector('#cbpSavedSel')?.classList.contains('selected');
  if(!passport || !dep){
    alert('Please complete the form.');
    return;
  }

  box.innerHTML = `
    <div class="cbp-body" style="place-items:center; text-align:center">
      <div class="spinner" aria-hidden="true" style="margin:30px 0"></div>
      <div style="font-weight:800; font-size:18px">Submitting form</div>
    </div>
  `;

  setTimeout(()=>{
    const trips = getTrips();
    const i = trips.findIndex(t => t.id === trip.id);
    if(i>-1){
      trips[i].cbpDone = true;
      trips[i].cbpPassport = passport;
      trips[i].cbpDeparture = dep;
      setTrips(trips);
    }
    if (useSaved) clearCBPForm();   // remove the saved form after successful submit
    close();
  }, 4000);
});
  }
    
function confirmDelete(tripId){
  const back = document.createElement('div'); back.className='confirm-backdrop';
  const box  = document.createElement('div'); box.className='confirm';

  box.innerHTML = `
    <h3>Delete this flight?</h3>
    <p>This will permanently remove it from Previous Trips.</p>
    <div class="row-btns">
      <button class="btn-outline" id="cCancel">Cancel</button>
      <button class="btn-danger"  id="cDel">Delete</button>
    </div>
  `;

  function close(){
    back.classList.remove('show'); box.classList.remove('show');
    document.body.classList.remove('modal-open');
    setTimeout(()=>{ back.remove(); box.remove(); }, 200);
  }

  back.addEventListener('click', close);
  box.querySelector('#cCancel').addEventListener('click', close);
  box.querySelector('#cDel').addEventListener('click', ()=>{
    const arr = getTrips();
    const i   = arr.findIndex(t => t.id === tripId);
    if (i > -1){ arr.splice(i,1); setTrips(arr); }
    close();
    // refresh UI
    renderTrips();
    renderStats?.();
    // if a detail sheet for this trip was open, close it cleanly
    try { closeSheet(); } catch(e){}
  });

  document.body.append(back, box);
  requestAnimationFrame(()=>{ 
    back.classList.add('show'); 
    box.classList.add('show'); 
    document.body.classList.add('modal-open'); 
  });
}

</script>
</body>
</html>
