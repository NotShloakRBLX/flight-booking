<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Book</title>
<style>
  :root{
    --bg:#0b0b0b;
    --card:#1d1f23;
    --cardBorder:rgba(255,255,255,.08);
    --muted:rgba(255,255,255,.66);
    --ink:#fff;
    --accent:#1e8bff;
    --accentHover:#2a96ff;
    --line:rgba(255,255,255,.16);
    --lineActive:#1e8bff;
    --shadow:0 18px 48px rgba(0,0,0,.45);
    --radiusCard:26px;
    --t:.28s cubic-bezier(.2,.8,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,Inter,system-ui,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
    color-scheme:dark;
  }

  .page{width:clamp(320px,92vw,420px); margin:0 auto; padding:22px 16px 40px;}
  h1{font-size:48px; line-height:1; margin:6px 4px 18px; font-weight:800; letter-spacing:-.4px}

  .card{
    position:relative; background:var(--card); border:1px solid var(--cardBorder);
    border-radius:var(--radiusCard); box-shadow:var(--shadow); padding:22px 20px 24px;
  }

  .grid{display:grid; grid-template-columns:1fr; row-gap:20px}
  .label{font-size:16px; color:var(--muted); margin:0 0 8px;}
  .row{position:relative}
  .line-wrap{position:relative; padding:0 0 12px;}
  .line-wrap::after{content:""; position:absolute; left:0; right:0; bottom:0; height:2px; background:var(--line); border-radius:2px;}
  .input, .select select{width:100%; background:transparent; border:0; outline:0; color:var(--ink); font-size:21px; padding:6px 34px 6px 0; line-height:1.25;}
  .input::placeholder{color:rgba(255,255,255,.55)}
  .focusbar{position:absolute; left:0; right:0; bottom:-1px; height:2px; background:var(--lineActive); transform:scaleX(0); transform-origin:left; transition:transform var(--t)}
  .input:focus ~ .focusbar, .select select:focus ~ .focusbar{transform:scaleX(1)}
  input[type="date"]{-webkit-appearance:none; appearance:none}
  input[type="date"]::-webkit-calendar-picker-indicator{opacity:0}
  .select{position:relative}
  .icon{position:absolute; right:0; top:50%; transform:translateY(-50%); width:20px; height:20px}
  .icon svg{width:100%; height:100%; display:block}
  .icon svg *{stroke:var(--accent); fill:none; stroke-width:1.9; stroke-linecap:round; stroke-linejoin:round}

  .swap{
    position:absolute; left:50%; top:-18px; transform:translateX(-50%);
    width:40px; height:40px; border-radius:50%;
    background:#2a2d33; border:1px solid var(--cardBorder);
    display:grid; place-items:center; box-shadow:0 6px 18px rgba(0,0,0,.34)
  }
  .swap svg{width:20px;height:20px}
  .swap svg path{stroke:var(--accent); fill:none; stroke-width:1.8; stroke-linecap:round; stroke-linejoin:round}

  .cta{margin-top:22px}
  .cta button{width:100%; height:60px; border-radius:34px; border:0; cursor:pointer; background:var(--accent); color:#fff; font-weight:800; font-size:24px; letter-spacing:.2px; box-shadow:0 12px 26px rgba(30,139,255,.33); transition:transform var(--t), background var(--t)}
  .cta button:hover{background:var(--accentHover)}
  .cta button:active{transform:translateY(1px)}

  /* ---------- OVERLAY ---------- */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:opacity var(--t);}
  .backdrop.show{opacity:1; pointer-events:auto}
  .sheet{position:fixed; left:50%; transform:translate(-50%, 100%); bottom:0; width:min(420px,96vw); max-height:86vh; background:var(--card); border:1px solid var(--cardBorder); border-radius:28px 28px 0 0; box-shadow:0 -18px 48px rgba(0,0,0,.6); overflow:hidden; transition:transform var(--t)}
  .sheet.show{transform:translate(-50%,0)}
  .sheet-header{position:sticky; top:0; background:linear-gradient(180deg, rgba(0,0,0,.22), transparent 70%), var(--card); padding:14px 16px 8px; z-index:2; display:flex; align-items:center; justify-content:center;}
  .route-title{font-weight:800; letter-spacing:.4px}
  .btn-back{position:absolute; left:10px; top:10px; width:36px; height:36px; border-radius:50%; border:1px solid var(--cardBorder); background:#2a2d33; display:grid; place-items:center}
  .btn-back svg{width:18px;height:18px}

  .view{padding:12px 16px 22px; max-height:calc(86vh - 76px); overflow:auto; animation:fadeSlideIn .28s var(--t) both;}
  @keyframes fadeSlideIn {from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:none}}

  .results{padding:10px 12px 18px;}
  .card-result{background:#22252a; border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:14px 14px 10px; margin:12px 4px; box-shadow:0 8px 24px rgba(0,0,0,.35); transition:transform var(--t), box-shadow var(--t), background var(--t)}
  .card-result:active{transform:translateY(1px); box-shadow:0 6px 18px rgba(0,0,0,.28); background:#202228}
  .row-top{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .pair{display:flex; align-items:baseline; gap:10px}
  .code{font-weight:800; letter-spacing:.6px; color:#ddd}
  .timepair{font-size:20px; font-weight:800; letter-spacing:.2px}
  .plus1{font-size:14px; color:var(--muted); margin-left:2px}
  .right-price{font-weight:800; font-size:20px; color:#2ea0ff; display:flex; align-items:center; gap:6px}
  .row-mid{color:var(--muted); margin:6px 0 0; display:flex; gap:14px; font-size:15px}
  .row-foot{margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,.06); display:flex; align-items:center; gap:8px; color:#ffcc66; font-size:14px}
  .row-foot.hide{display:none}

  .panel{background:#23262c; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px 14px 12px; margin:10px 0; box-shadow:0 8px 22px rgba(0,0,0,.32)}
  .panel h3{margin:0 0 8px; font-size:20px}
  .kv{display:flex; justify-content:space-between; margin:6px 0; color:#cfd6dd; gap:12px}
  .kv b{color:#fff}
  .btn-lg{width:100%; height:56px; border-radius:30px; border:0; background:var(--accent); color:#fff; font-weight:800; font-size:20px; box-shadow:0 10px 24px rgba(30,139,255,.33); cursor:pointer; transition:transform var(--t), background var(--t)}
  .btn-lg:active{transform:translateY(1px)}

  .info{background:#1d3a54; border:1px solid rgba(67,153,255,.4)}
  .info .title{font-weight:800; margin-bottom:8px}
  .muted{color:#aab2ba}

  .form-row{display:grid; gap:12px; grid-template-columns:1fr; width:100%}
  .form-row.half{grid-template-columns:repeat(2, minmax(0,1fr))}
  @media (max-width: 360px){ .form-row.half{grid-template-columns:1fr} }
  .field{display:flex; flex-direction:column; gap:6px; min-width:0}
  .field label{color:#c8ced6; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .field input, .field select{width:100%; max-width:100%; background:#121317; color:#fff; border:1px solid rgba(255,255,255,.16); border-radius:12px; padding:12px 12px; font-size:16px; outline:none; -webkit-appearance:none; appearance:none;}
  .agree{display:flex; align-items:flex-start; gap:10px; margin:12px 0 8px; color:#cfd6dd}
  .agree input{margin-top:4px}

  @media (min-width:480px){ .sheet, .page{width:420px} }
</style>
</head>
<body>
  <main class="page">
    <h1>Book</h1>

    <section class="card" aria-label="Flight Search">
      <div class="swap" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M3 7h12"></path><path d="M10 3l5 4-5 4"></path><path d="M21 17H9"></path><path d="M14 21l-5-4 5-4"></path></svg>
      </div>

      <div class="grid">
        <div class="row">
          <div class="label">From</div>
          <div class="line-wrap select">
            <select id="from" aria-label="From">
              <option value="" selected disabled>City / airport</option>
            </select>
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4.5 12.8l14.6-8.75c.5-.3 1.1.23.83.76L13.6 20.9a.7.7 0 0 1-1.31-.06l-1.24-5.17-5.17-1.24a.7.7 0 0 1 .06-1.31z"></path></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>

        <div class="row">
          <div class="label">To</div>
          <div class="line-wrap select">
            <select id="to" aria-label="To">
              <option value="" selected disabled>City / airport</option>
            </select>
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4.5 12.8l14.6-8.75c.5-.3 1.1.23.83.76L13.6 20.9a.7.7 0 0 1-1.31-.06l-1.24-5.17-5.17-1.24a.7.7 0 0 1 .06-1.31z"></path></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>

        <div class="row">
          <div class="label">Depart</div>
          <div class="line-wrap">
            <input id="depart" class="input" type="date" aria-label="Depart date" />
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="16" rx="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="8" y1="3" x2="8" y2="7"></line><line x1="16" y1="3" x2="16" y2="7"></line></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>

        <div class="row">
          <div class="label">Return</div>
          <div class="line-wrap">
            <input id="return" class="input" type="date" aria-label="Return date (ignored for one-way)" />
            <div class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="16" rx="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="8" y1="3" x2="8" y2="7"></line><line x1="16" y1="3" x2="16" y2="7"></line></svg>
            </div>
            <div class="focusbar"></div>
          </div>
        </div>

        <div class="row">
          <div class="label">Passengers</div>
          <div class="line-wrap select">
            <select id="pax" aria-label="Passengers">
              <option selected>1</option><option>2</option><option>3</option>
              <option>4</option><option>5</option><option>6</option>
            </select>
            <div class="focusbar"></div>
          </div>
        </div>
      </div>

      <div class="cta"><button id="btnSearch" type="button">Search</button></div>
    </section>
  </main>

  <div class="backdrop" id="backdrop"></div>
  <section class="sheet" id="sheet" aria-modal="true" role="dialog">
    <div class="sheet-header">
      <button class="btn-back" id="btnBack" aria-label="Back">
        <svg viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" stroke="#9aa3af" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="route-title" id="routeTitle">RFD – PER</div>
    </div>
    <div id="sheetBody" class="view"></div>
  </section>

<script>
/* -------------------- Airports + form behavior -------------------- */
const AIRPORTS = [
  { code:'RFD', name:'Rockford Intl Airport (RFD)' },
  { code:'MLR', name:'Mellor Regional Airport (MLR)' },
  { code:'PER', name:'Perth Intl Airport (PER)' },
  { code:'IZO', name:'Izolirani Intl Airport (IZO)' },
  { code:'LCA', name:'Larnaca Intl Airport (LCA)' },
  { code:'PHP', name:'Phaphos Regional Airport (PHP)' },
  { code:'HND', name:'Tokyo Haneda Intl (HND)' },
  { code:'GRV', name:'Grindavik Intl Airport (GRV)' },
  { code:'SAU', name:'Sauthemptona Airport (SAU)' }
];

const fromSel = document.getElementById('from');
const toSel   = document.getElementById('to');

function fillSelect(selectEl, excludeCode) {
  const current = selectEl.value;
  selectEl.innerHTML = '<option value="" disabled selected>City / airport</option>';
  AIRPORTS.forEach(a => {
    if (a.code !== excludeCode) {
      const opt = document.createElement('option');
      opt.value = a.code; opt.textContent = a.name;
      selectEl.appendChild(opt);
    }
  });
  if (current && current !== excludeCode) {
    const exists = Array.from(selectEl.options).some(o => o.value === current);
    if (exists) selectEl.value = current;
  }
}
fillSelect(fromSel);
fillSelect(toSel);
fromSel.addEventListener('change', () => fillSelect(toSel, fromSel.value || null));

/* -------------------- Overlay + transitions -------------------- */
const backdrop = document.getElementById('backdrop');
const sheet = document.getElementById('sheet');
const btnBack = document.getElementById('btnBack');
const sheetBody = document.getElementById('sheetBody');
const routeTitle = document.getElementById('routeTitle');
let stepStack = [];

function openSheet(){ backdrop.classList.add('show'); sheet.classList.add('show'); }
function closeSheet(){ sheet.classList.remove('show'); backdrop.classList.remove('show'); stepStack = []; }
btnBack.addEventListener('click', () => {
  if (stepStack.length <= 1) { closeSheet(); return; }
  stepStack.pop();
  const prev = stepStack[stepStack.length-1];
  renderView(prev.title, prev.html);
});

/* -------------------- Utilities -------------------- */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]); }
function randomUniqueTimes(n){ const s=new Set(); while(s.size<n) s.add(randInt(0,1439)); return [...s]; }
function minutesToTime(mins){
  mins = ((mins % (24*60)) + (24*60)) % (24*60);
  const h24 = Math.floor(mins/60), m = mins % 60;
  const h12 = ((h24 + 11) % 12) + 1;
  const ampm = h24 < 12 ? 'AM' : 'PM';
  return `${h12}:${m.toString().padStart(2,'0')} ${ampm}`;
}
function overnightFlag(depMins, arrMins){ const w=t=>t>=0&&t<360; return w(depMins%1440)||w(arrMins%1440); }

/* Airline codes (used on Review & Pay) */
const AIRLINE_CODES = {
  'American Airlines':'AA','JetBlue':'B6','Delta':'DL','United':'UA','Southwest':'WN','Spirit':'NK',
  'Emirates':'EK','Singapore Airlines':'SQ','Lufthansa':'LH','SWISS':'LX','Korean Air':'KE','KLM':'KL','Qatar Airways':'QR','Air France':'AF'
};

/* Country mapping for INTL check */
function countryOf(code){
  if (['RFD','PER','LCA','PHP','MLR','IZO'].includes(code)) return 'US';
  if (['HND','GRV','SAU'].includes(code)) return 'JP';
  return 'US';
}
function isIntl(a,b){ return countryOf(a) !== countryOf(b); }

/* -------------------- NEW: Aircraft rules per route+airline -------------------- */
const AIRCRAFT_RULES = {
  'PER-RFD': {
    'American Airlines':['A320','B737'],
    'JetBlue':['A320'],
    'Spirit':['A320'],
    'Delta':['A320'],
    'United':['A320','B737'],
    'Southwest':['B737']
  },
  'IZO-RFD': {
    'American Airlines':['B737','A320'],
    'JetBlue':['A320'],
    'Southwest':['B737'],
    'Delta':['A320']
  },
  'LCA-RFD': {
    'JetBlue':['A320'],
    'Delta':['A320','B737','B757','CRJ700'],
    'Southwest':['B737'],
    'American Airlines':['A320','B737'],
    'United':['A320','B737']
  },
  'PHP-RFD': {
    'JetBlue':['A320'],
    'Delta':['A320'],
    'United':['A320'],
    'Southwest':['B737'],
    'American Airlines':['A320']
  },
  'HND-RFD': {
    'Lufthansa':['A350','A380','B747'],
    'Delta':['A350','B757'],
    'Emirates':['A380','B777','A350'],
    'Singapore Airlines':['A350','B777'],
    'United':['B777'],
    'American Airlines':['B777','B787'],
    'KLM':['B777'],
    'SWISS':['A330','B777'],
    'Korean Air':['A380'],
    'Qatar Airways':['B777','A350','A380'],
    'Air France':['B777']
  }
};

function routeKey(a,b){ return [a,b].sort().join('-'); }
function pickAircraft(fromCode,toCode,carrier){
  const rules = AIRCRAFT_RULES[routeKey(fromCode,toCode)];
  if(!rules || !rules[carrier] || rules[carrier].length===0) return '';
  const list = rules[carrier];
  return list[randInt(0, list.length-1)];
}

/* -------------------- Route generators -------------------- */
function buildRfdPerResults(from,to){
  const carriers=['American Airlines','JetBlue',...shuffle(['United','Spirit','Southwest','Delta'])];
  const depTimes=randomUniqueTimes(6);
  const durations=Array.from({length:6},()=>randInt(120,180));
  const allPrices=Array.from({length:6},()=>randInt(250,600));
  const sorted=[...allPrices].sort((a,b)=>a-b), cheap1=sorted[0], cheap2=sorted[1];
  const rest=[...allPrices]; let i=rest.indexOf(cheap1); if(i>-1)rest.splice(i,1); i=rest.indexOf(cheap2); if(i>-1)rest.splice(i,1);
  const prices=[cheap1,cheap2,...rest];
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

function buildRfdIzoResults(from,to){
  const carriers=['American Airlines','American Airlines','JetBlue',...shuffle(['JetBlue','Southwest','Delta'])];
  const depTimes=randomUniqueTimes(6), durations=Array.from({length:6},()=>randInt(120,180)), prices=Array.from({length:6},()=>randInt(250,600));
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

function buildRfdLcaResults(from,to){
  const carriers=['JetBlue','Delta','Delta',...shuffle(['American Airlines','Southwest','United'])];
  const depTimes=randomUniqueTimes(6), durations=Array.from({length:6},()=>randInt(90,120)), prices=Array.from({length:6},()=>randInt(250,550));
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

function buildRfdPhpResults(from,to){
  const carriers=['JetBlue','JetBlue','Delta',...shuffle(['American Airlines','United','Southwest'])];
  const depTimes=randomUniqueTimes(6), durations=Array.from({length:6},()=>randInt(90,120)), prices=Array.from({length:6},()=>randInt(250,550));
  return carriers.map((c,idx)=>{const d=depTimes[idx],du=durations[idx],a=d+du;return{
    from,to,depart:minutesToTime(d),arrive:minutesToTime(a),
    plusOne:Math.floor(a/1440)>Math.floor(d/1440)?'+1':'',
    durationMin:du,durationText:`${Math.floor(du/60)}h ${String(du%60).padStart(2,'0')}m`,
    nonstop:true,price:prices[idx],carrier:c,overnight:overnightFlag(d,a),
    aircraft: pickAircraft(from,to,c)
  }});
}

/* RFD ↔ HND (Tokyo) */
function buildRfdHndResults(fromCode, toCode){
  const firstSix = shuffle(['American Airlines','Delta','Emirates','Singapore Airlines','United','Lufthansa']);
  const pool = ['SWISS','Korean Air','KLM','Qatar Airways','Air France'];
  const lastSix = shuffle((() => { const out=[...pool]; while(out.length<6) out.push(pool[randInt(0,pool.length-1)]); return out; })());
  const carriers = [...firstSix, ...lastSix];

  const depTimes  = randomUniqueTimes(12);
  const durations = Array.from({length:12}, () => randInt(510, 720));  // 8h30–12h
  const prices    = Array.from({length:12}, () => randInt(900, 1100));

  const tzDelta =
    (countryOf(fromCode) === 'US' && countryOf(toCode) === 'JP') ? 360 :
    (countryOf(fromCode) === 'JP' && countryOf(toCode) === 'US') ? -360 : 0;

  return carriers.map((carrier, i) => {
    const depMins = depTimes[i];
    const dur     = durations[i];
    const arrMins = depMins + dur + tzDelta;
    return {
      from: fromCode,
      to: toCode,
      depart: minutesToTime(depMins),
      arrive: minutesToTime(arrMins),
      plusOne: Math.floor(arrMins/1440) > Math.floor(depMins/1440) ? '+1' : '',
      durationMin: dur,
      durationText: `${Math.floor(dur/60)}h ${String(dur%60).padStart(2,'0')}m`,
      nonstop: true,
      price: prices[i],
      carrier,
      overnight: overnightFlag(depMins, arrMins),
      aircraft: pickAircraft(fromCode,toCode,carrier)
    };
  });
}

/* -------------------- Results list -------------------- */
function resultsView(list){
  const div=document.createElement('div'); div.className='results';
  list.forEach(opt=>{
    const card=document.createElement('div'); card.className='card-result';
    card.innerHTML=`
      <div class="row-top">
        <div class="pair"><div class="code">${opt.from}</div><div class="arrow">→</div><div class="code">${opt.to}</div></div>
        <div class="right-price"><span>$${opt.price.toLocaleString()}</span>
          <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
      <div class="row-top" style="margin-top:6px"><div class="timepair">${opt.depart} &nbsp;→&nbsp; ${opt.arrive} ${opt.plusOne?`<span class="plus1">${opt.plusOne}</span>`:''}</div></div>
      <div class="row-mid"><div>${opt.durationText}</div><div>Nonstop</div><div style="color:#9aa3af;">${opt.carrier}</div></div>
      <div class="row-foot ${opt.overnight?'':'hide'}">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 9v4m0 4h.01M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2z" stroke="#ffcc66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Overnight flight or connection</span>
      </div>`;
    card.addEventListener('click',()=>openSummary(opt));
    div.appendChild(card);
  });
  return div;
}

function renderView(title, node){
  routeTitle.textContent = title;
  sheetBody.innerHTML = '';
  sheetBody.appendChild(node);
}

/* -------------------- Steps -------------------- */
let lastSelection=null;

function openSummary(opt){
  lastSelection = {...opt, airlineCode: AIRLINE_CODES[opt.carrier] || ''};
  const v=document.createElement('div'); v.className='view';

  const warn=opt.overnight?`
    <div class="panel" style="color:#ffcc66; display:flex; align-items:center; gap:8px">
      <svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 9v4m0 4h.01M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2z" stroke="#ffcc66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Overnight flight or connection
    </div>`:'';

  v.innerHTML=`
    <div class="panel">
      <div style="font-weight:800; color:#21d07a; margin-bottom:6px">DEPART</div>
      <div style="font-size:17px; color:#e9eef4; margin-bottom:6px">${opt.from} to ${opt.to}</div>
      <div class="kv"><span><b>${opt.depart}</b> → <b>${opt.arrive}</b> ${opt.plusOne?'<span class="muted">+1</span>':''}</span><span>Nonstop</span></div>
      <div class="kv"><span>Duration</span><b>${opt.durationText}</b></div>
      <div class="kv"><span>Aircraft</span><b>${opt.aircraft || '—'}</b></div>
    </div>
    ${warn}
    <div class="panel"><div class="kv"><span>Total amount due</span><b>$${opt.price.toLocaleString()}</b></div></div>
    <button class="btn-lg" id="goPassengers">Continue</button>`;
  v.querySelector('#goPassengers').addEventListener('click',()=>openPassengers());
  if(!stepStack.length) openSheet();
  stepStack=[{title:'Your trip summary', html:v}];
  renderView('Your trip summary', v);
}

function openPassengers(){
  const intl=isIntl(lastSelection.from,lastSelection.to);
  const v=document.createElement('div'); v.className='view';
  const info=intl?`
    <div class="panel info">
      <div class="title">Know before you go</div>
      <div class="muted">International travel requires a valid passport. Check visa and travel document requirements for your destination.</div>
    </div>`:'';

  v.innerHTML=`
    ${info}
    <div class="panel"><div class="kv"><span>Your trip total</span><b>$${lastSelection.price.toLocaleString()}</b></div></div>

    <div class="panel">
      <h3>Passenger 1</h3>
      <div class="form-row">
        <div class="field"><label>First name •</label><input type="text" placeholder="As on ID" autocomplete="given-name"></div>
        <div class="field"><label>Middle name</label><input type="text" placeholder="Optional" autocomplete="additional-name"></div>
        <div class="field"><label>Last name •</label><input type="text" placeholder="As on ID" autocomplete="family-name"></div>
      </div>
      <div class="form-row half" style="margin-top:8px">
        <div class="field"><label>Date of birth •</label><input type="date" autocomplete="bday"></div>
        <div class="field"><label>Gender •</label>
          <select autocomplete="sex"><option value="" disabled selected>Select</option><option>Female</option><option>Male</option><option>Unspecified</option></select>
        </div>
      </div>
    </div>

    <button class="btn-lg" id="goPay">Continue</button>`;
  v.querySelector('#goPay').addEventListener('click',()=>openReviewPay());
  stepStack.push({title:'Passengers', html:v});
  renderView('Passengers', v);
}

function openReviewPay(){
  const v=document.createElement('div'); v.className='view';
  v.innerHTML=`
    <div class="panel">
      <div style="font-weight:800; margin-bottom:6px">Your trip</div>
      <div style="font-size:16px; margin-bottom:6px">${lastSelection.from} → ${lastSelection.to}</div>
      <div class="kv"><span><b>${lastSelection.depart}</b> → <b>${lastSelection.arrive}</b> ${lastSelection.plusOne?'<span class="muted">+1</span>':''}</span><span>${lastSelection.airlineCode}</span></div>
      <div class="kv"><span>Duration</span><b>${lastSelection.durationText}</b></div>
      <div class="kv"><span>Stops</span><b>Nonstop</b></div>
    </div>

    <div class="panel">
      <h3>Cost summary</h3>
      <div class="kv"><span>Economy</span><b>$${lastSelection.price.toLocaleString()}</b></div>
      <div class="kv" style="border-top:1px solid rgba(255,255,255,.1); padding-top:8px; margin-top:8px;">
        <span>Total amount due (All passengers)</span><b>$${lastSelection.price.toLocaleString()}</b>
      </div>
    </div>

    <div class="panel">
      <h3>Credit / debit card</h3>
      <div class="form-row">
        <div class="field"><label>Card number •</label><input type="text" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456"></div>
        <div class="form-row half">
          <div class="field"><label>Expiry date •</label><input type="text" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY"></div>
          <div class="field"><label>Security code •</label><input type="text" inputmode="numeric" autocomplete="cc-csc" placeholder="CVV" maxlength="4"></div>
        </div>
        <div class="field"><label>Billing address •</label><input type="text" autocomplete="address-line1" placeholder="Street address"></div>
        <div class="form-row half">
          <div class="field"><label>Cardholder name •</label><input type="text" autocomplete="cc-name" placeholder="Full name"></div>
          <div class="field"><label>Postal code •</label><input type="text" autocomplete="postal-code" placeholder="ZIP / Postal"></div>
        </div>
      </div>
      <label class="agree"><input type="checkbox"><span>I agree to the terms and conditions, refund policy, and conditions of carriage.</span></label>
      <button class="btn-lg">Pay now</button>
      <div class="muted" style="display:flex; align-items:center; gap:6px; margin-top:8px">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.25 3.438 10.063 9 12 5.563-1.938 9-6.75 9-12V5l-9-4z" fill="none" stroke="#9aa3af" stroke-width="1.5"/></svg>
        Secure checkout
      </div>
    </div>`;
  stepStack.push({title:'Review and pay', html:v});
  renderView('Review and pay', v);
}

/* -------------------- Search handler -------------------- */
document.getElementById('btnSearch').addEventListener('click', () => {
  const from = fromSel.value, to = toSel.value;
  const departDate = document.getElementById('depart').value;

  if (!from || !to || !departDate) {
    const formCard = document.querySelector('.card');
    formCard.style.boxShadow = '0 0 0 4px rgba(255,80,80,.25)';
    setTimeout(()=>formCard.style.boxShadow = 'var(--shadow)', 350);
    return;
  }

  const key=[from,to].sort().join('-');
  let list;
  if (key==='PER-RFD') list=buildRfdPerResults(from,to);
  else if (key==='IZO-RFD') list=buildRfdIzoResults(from,to);
  else if (key==='LCA-RFD') list=buildRfdLcaResults(from,to);
  else if (key==='PHP-RFD') list=buildRfdPhpResults(from,to);
  else if (key==='HND-RFD') list=buildRfdHndResults(from,to);
  else {
    const v=document.createElement('div'); v.className='view';
    v.innerHTML=`<div class="panel"><div class="kv"><span>Route</span><b>${from} → ${to}</b></div>
      <div class="muted">This prototype currently supports Rockford (RFD) ↔ Perth (PER), Rockford (RFD) ↔ Izolirani (IZO), Rockford (RFD) ↔ Larnaca (LCA), Rockford (RFD) ↔ Phaphos (PHP), and Rockford (RFD) ↔ Tokyo (HND).</div></div>`;
    openSheet(); renderView('Choose departure', v); stepStack=[{title:'Choose departure', html:v}];
    return;
  }

  const resNode = resultsView(list);
  openSheet(); renderView('Choose departure', resNode); stepStack=[{title:'Choose departure', html:resNode}];
});
</script>
</body>
</html>
